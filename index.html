<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ í˜¼ìë§Œ ë ˆë²¨ì—…: THE SYSTEM</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        system: {
                            dark: '#0a0e17',
                            blue: '#00a8ff',
                            glow: '#0077ff',
                            text: '#e0f2fe',
                            panel: '#111827'
                        }
                    },
                    fontFamily: {
                        sans: ['Pretendard', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace'],
                    },
                    animation: {
                        'pulse-glow': 'pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'typewriter': 'typewriter 0.5s steps(40, end)',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'attack-thrust': 'attack-thrust 0.2s ease-in-out',
                        'damage-shake': 'damage-shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                        'skill-flash': 'skill-flash 0.5s ease-out',
                    },
                    keyframes: {
                        'pulse-glow': {
                            '0%, 100%': { opacity: 1, boxShadow: '0 0 10px #0077ff' },
                            '50%': { opacity: .7, boxShadow: '0 0 20px #00a8ff' },
                        },
                        'shake': {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        'attack-thrust': {
                            '0%': { transform: 'translateY(0) scale(1)' },
                            '50%': { transform: 'translateY(-20px) scale(1.05)' },
                            '100%': { transform: 'translateY(0) scale(1)' }
                        },
                        'damage-shake': {
                             '0%': { transform: 'translate(0, 0)' },
                             '25%': { transform: 'translate(5px, 5px)' },
                             '50%': { transform: 'translate(-5px, -5px)' },
                             '75%': { transform: 'translate(5px, -5px)' },
                             '100%': { transform: 'translate(0, 0)' }
                        },
                        'skill-flash': {
                            '0%': { opacity: 0, transform: 'scale(0.8)' },
                            '50%': { opacity: 1, transform: 'scale(1.2)' },
                            '100%': { opacity: 0, transform: 'scale(1.5)' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & Babel -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0"
  }
}
</script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background-color: #050505; color: white; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0a0e17; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e3a8a; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #0077ff; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useRef } from 'react';
        import ReactDOM from 'react-dom/client';

        // --- CONSTANTS & TYPES ---
        
        const PlayerClass = {
            NONE: "ë¬´ì§",
            NECROMANCER: "ë„¤í¬ë¡œë§¨ì„œ",
            SHADOW_MONARCH: "ê·¸ë¦¼ì êµ°ì£¼"
        };

        const Rank = {
            E: "E", D: "D", C: "C", B: "B", A: "A", S: "S"
        };

        const STORIES = [
            { id: 0, title: "ê°ì„±: ì¸ìŠ¤í„´ìŠ¤ ë˜ì „", description: "í•©ì •ì—­ ì§€í•˜ì²  ì—­. ë‚˜ë§Œì˜ ë ˆë²¨ì—…ì´ ì‹œì‘ëœë‹¤.", requiredLevel: 1, bossName: "í‘¸ë¥¸ ë…ë‹ˆ ì¹´ì‚¬ì¹´", bossRank: Rank.C },
            { id: 1, title: "ì „ì§ í€˜ìŠ¤íŠ¸: ê¸°ì‚¬ë‹¨ì¥", description: "ê·¸ë¦¼ì ì†ì— ìˆ¨ì–´ìˆëŠ” ë¶‰ì€ ê¸°ì‚¬ì™€ì˜ ê²°íˆ¬.", requiredLevel: 10, bossName: "í•ë¹›ì˜ ì´ê·¸ë¦¬ìŠ¤", bossRank: Rank.A },
            { id: 2, title: "ë ˆë“œ ê²Œì´íŠ¸: ì„¤ì›", description: "ì–¼ì–´ë¶™ì€ ìˆ² ì†, ë°±ê·€ë“¤ê³¼ì˜ ì‚¬íˆ¬.", requiredLevel: 20, bossName: "ë°±ê·€ì˜ ì™•", bossRank: Rank.A },
            { id: 3, title: "ì•…ë§ˆì˜ ì„±", description: "ì§€ì˜¥ì˜ ë¶ˆê¸¸ ì†ì—ì„œ ì•…ë§ˆì™• ë°”ë€ì„ ì²˜ì¹˜í•˜ë¼.", requiredLevel: 35, bossName: "ì•…ë§ˆì™• ë°”ë€", bossRank: Rank.S },
            { id: 4, title: "ì œì£¼ë„ ë ˆì´ë“œ", description: "Sê¸‰ ê²Œì´íŠ¸. ê°œë¯¸ë“¤ì˜ ì™•ì´ ê¸°ë‹¤ë¦°ë‹¤.", requiredLevel: 50, bossName: "ê°œë¯¸ì˜ ì™• ë² ë¥´", bossRank: Rank.S },
        ];

        // --- COMPONENTS ---

        // GameLog Component
        const GameLog = ({ logs }) => {
            const bottomRef = useRef(null);

            useEffect(() => {
                bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [logs]);

            return (
                <div className="flex-1 bg-system-panel/50 border border-system-blue/30 p-4 overflow-y-auto min-h-[200px] max-h-[300px] lg:max-h-[400px] rounded-lg backdrop-blur-sm custom-scrollbar">
                    <div className="flex flex-col space-y-2">
                        {logs.length === 0 && (
                            <div className="text-gray-500 text-sm italic text-center my-10">
                                ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
                            </div>
                        )}
                        {logs.map((log) => (
                            <div key={log.id} className={`text-sm font-mono animate-typewriter overflow-hidden whitespace-normal break-words
                                ${log.type === 'system' ? 'text-system-blue font-bold' : ''}
                                ${log.type === 'danger' ? 'text-red-500 font-bold' : ''}
                                ${log.type === 'gain' ? 'text-green-400' : ''}
                                ${log.type === 'combat' ? 'text-gray-300' : ''}
                                ${log.type === 'info' ? 'text-gray-400' : ''}
                                ${log.type === 'story' ? 'text-yellow-400 font-bold' : ''}
                            `}>
                                <span className="opacity-50 text-xs mr-2">[{new Date(log.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}]</span>
                                {log.type === 'system' && 'ã€SYSTEMã€‘ '}
                                {log.text}
                            </div>
                        ))}
                        <div ref={bottomRef} />
                    </div>
                </div>
            );
        };

        // StatusWindow Component
        const StatusWindow = ({ player, onIncreaseStat, onOpenUpgradeModal, onToggleEquip, onOpenCodeModal }) => {
            
            const getEquippedBonus = (type) => {
                return player.inventory
                    .filter(i => i.isEquipped && i.type === type)
                    .reduce((acc, curr) => acc + curr.effectValue, 0);
            };

            const attackBonus = getEquippedBonus('WEAPON');
            const defenseBonus = getEquippedBonus('ARMOR');

            return (
                <div className="w-full lg:w-1/3 bg-black/80 border border-system-blue shadow-[0_0_15px_rgba(0,168,255,0.2)] p-4 rounded-lg text-system-text font-sans relative overflow-hidden group flex flex-col gap-6 h-fit">
                    <div className="absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] z-0 pointer-events-none bg-[length:100%_2px,3px_100%]"></div>
                    
                    <div className="relative z-10">
                        <div className="flex justify-between items-center mb-4 border-b border-system-blue/50 pb-2">
                            <h2 className="text-2xl font-bold text-system-blue tracking-widest">STATUS</h2>
                            {onOpenCodeModal && (
                                <button 
                                    onClick={onOpenCodeModal} 
                                    className="text-[10px] bg-system-blue/20 hover:bg-system-blue text-system-blue hover:text-black border border-system-blue px-3 py-1 rounded transition-all font-bold tracking-wider hover:shadow-[0_0_10px_#00a8ff]"
                                >
                                    ADMIN CODE
                                </button>
                            )}
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <p className="text-xs text-gray-400">NAME</p>
                                <div className="flex items-center gap-2">
                                    <p className="text-lg font-bold">{player.name}</p>
                                </div>
                            </div>
                            <div>
                                <p className="text-xs text-gray-400">LEVEL</p>
                                <p className="text-lg font-bold text-yellow-400">{player.level}</p>
                            </div>
                            <div>
                                <p className="text-xs text-gray-400">JOB</p>
                                <p className="text-sm">{player.job}</p>
                            </div>
                            <div>
                                <p className="text-xs text-gray-400">TITLE</p>
                                <p className="text-sm">{player.title}</p>
                            </div>
                        </div>

                        <div className="mb-6 space-y-3">
                            <div>
                                <div className="flex justify-between text-xs mb-1">
                                    <span className="text-red-400 font-bold">HP</span>
                                    <span>{player.hp} / {player.maxHp}</span>
                                </div>
                                <div className="h-2 bg-gray-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-red-600 transition-all duration-300" style={{ width: `${Math.max(0, (player.hp / player.maxHp) * 100)}%` }} />
                                </div>
                            </div>
                            <div>
                                <div className="flex justify-between text-xs mb-1">
                                    <span className="text-blue-400 font-bold">MP</span>
                                    <span>{player.mp} / {player.maxMp}</span>
                                </div>
                                <div className="h-2 bg-gray-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-blue-600 transition-all duration-300" style={{ width: `${Math.max(0, (player.mp / player.maxMp) * 100)}%` }} />
                                </div>
                            </div>
                            <div>
                                <div className="flex justify-between text-xs mb-1">
                                    <span className="text-yellow-400 font-bold">EXP</span>
                                    <span>{player.currentExp} / {player.maxExp}</span>
                                </div>
                                <div className="h-1 bg-gray-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-yellow-500 transition-all duration-300" style={{ width: `${(player.currentExp / player.maxExp) * 100}%` }} />
                                </div>
                            </div>
                        </div>

                        <div className="space-y-2">
                            <div className="flex justify-between items-center border-b border-gray-800 pb-1">
                                <span className="text-sm text-gray-400">ëŠ¥ë ¥ì¹˜ í¬ì¸íŠ¸</span>
                                <span className={`font-mono font-bold ${player.statPoints > 0 ? 'text-yellow-400 animate-pulse' : 'text-gray-600'}`}>
                                    {player.statPoints}
                                </span>
                            </div>

                            {['strength', 'agility', 'sense', 'vitality', 'intelligence'].map((stat) => (
                                <div key={stat} className="flex items-center justify-between h-8">
                                    <span className="text-sm uppercase w-24 text-gray-300">
                                        {stat === 'strength' && 'ê·¼ë ¥ (STR)'}
                                        {stat === 'agility' && 'ë¯¼ì²© (AGI)'}
                                        {stat === 'sense' && 'ê°ê° (SNS)'}
                                        {stat === 'vitality' && 'ì²´ë ¥ (VIT)'}
                                        {stat === 'intelligence' && 'ì§€ëŠ¥ (INT)'}
                                    </span>
                                    <div className="flex gap-2">
                                        <span className="font-mono text-system-blue font-bold">{player.stats[stat]}</span>
                                        {stat === 'strength' && attackBonus > 0 && <span className="text-xs text-green-400 flex items-center">(+{attackBonus})</span>}
                                        {stat === 'vitality' && defenseBonus > 0 && <span className="text-xs text-green-400 flex items-center">(+{defenseBonus})</span>}
                                    </div>
                                    {player.statPoints > 0 && (
                                        <button 
                                            onClick={() => onIncreaseStat(stat)}
                                            className="ml-2 w-6 h-6 rounded bg-system-blue/20 text-system-blue hover:bg-system-blue hover:text-black text-xs flex items-center justify-center transition-colors"
                                        >
                                            +
                                        </button>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="relative z-10 border-t border-gray-800 pt-4">
                        <h3 className="text-sm font-bold text-gray-400 mb-3">ì¥ë¹„ / ì¸ë²¤í† ë¦¬</h3>
                        <div className="grid grid-cols-4 gap-2">
                            {player.inventory.map((item, idx) => (
                                <button 
                                    key={idx}
                                    onClick={() => onToggleEquip(item)}
                                    className={`relative aspect-square border rounded p-1 flex items-center justify-center group overflow-hidden
                                        ${item.isEquipped ? 'border-system-blue bg-system-blue/20 shadow-[0_0_10px_rgba(0,168,255,0.3)]' : 'border-gray-700 bg-gray-900/50 hover:border-gray-500'}
                                    `}
                                    title={item.name + (item.count ? ` x${item.count}` : '')}
                                >
                                    <span className="text-xl">{item.type === 'WEAPON' ? 'âš”ï¸' : item.type === 'ARMOR' ? 'ğŸ›¡ï¸' : 'ğŸ’Š'}</span>
                                    {item.count && item.count > 1 && (
                                        <span className="absolute bottom-0 right-0 bg-black/80 text-[10px] px-1 rounded-tl">{item.count}</span>
                                    )}
                                    {item.isEquipped && (
                                        <div className="absolute top-0 right-0 w-2 h-2 bg-system-blue rounded-full shadow-[0_0_5px_#00a8ff]"></div>
                                    )}
                                </button>
                            ))}
                            {Array.from({ length: Math.max(0, 8 - player.inventory.length) }).map((_, i) => (
                                <div key={`empty-${i}`} className="aspect-square border border-gray-800 bg-black/30 rounded"></div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ActionPanel Data & Logic ---
        
        const ENEMIES_BY_RANK = {
            [Rank.E]: [
                { name: "ê³ ë¸”ë¦°", rank: Rank.E, hp: 50, maxHp: 50, attack: 8, description: "ì‘ê³  êµí™œí•œ ëª¬ìŠ¤í„°ì…ë‹ˆë‹¤.", isBoss: false },
                { name: "ìŠ¬ë¼ì„", rank: Rank.E, hp: 60, maxHp: 60, attack: 5, description: "ì ì•¡ì§ˆì˜ ëª¬ìŠ¤í„°ì…ë‹ˆë‹¤.", isBoss: false },
                { name: "ê°•ì²  ì´ë¹¨ ëŠ‘ëŒ€", rank: Rank.E, hp: 80, maxHp: 80, attack: 12, description: "ë‚ ì¹´ë¡œìš´ ì´ë¹¨ì„ ê°€ì¡ŒìŠµë‹ˆë‹¤.", isBoss: false }
            ],
            [Rank.D]: [
                { name: "í™‰ ê³ ë¸”ë¦°", rank: Rank.D, hp: 150, maxHp: 150, attack: 25, description: "ì¼ë°˜ ê³ ë¸”ë¦°ë³´ë‹¤ ë©ì¹˜ê°€ í½ë‹ˆë‹¤.", isBoss: false },
                { name: "ìŠ¤í†¤ ê³¨ë ˜", rank: Rank.D, hp: 300, maxHp: 300, attack: 15, description: "ëŒë¡œ ì´ë£¨ì–´ì§„ ë‹¨ë‹¨í•œ ëª¬ìŠ¤í„°ì…ë‹ˆë‹¤.", isBoss: false }
            ],
            [Rank.C]: [
                { name: "ë¦¬ìë“œë§¨", rank: Rank.C, hp: 400, maxHp: 400, attack: 45, description: "ë¹„ëŠ˜ë¡œ ë®ì¸ ì¸ê°„í˜• ëª¬ìŠ¤í„°ì…ë‹ˆë‹¤.", isBoss: false },
                { name: "ìì´ì–¸íŠ¸ ìŠ¤íŒŒì´ë”", rank: Rank.C, hp: 350, maxHp: 350, attack: 50, description: "ê±°ëŒ€í•œ ë…ê±°ë¯¸ì…ë‹ˆë‹¤.", isBoss: false },
                { name: "ê³ ë¸”ë¦° ë§ˆë²•ì‚¬", rank: Rank.C, hp: 250, maxHp: 250, attack: 70, description: "í™”ì—¼êµ¬ë¥¼ ë˜ì§€ëŠ” ê³ ë¸”ë¦°ì…ë‹ˆë‹¤.", isBoss: false },
                { name: "ë‹¤í¬ ì—˜í”„ ê¶ìˆ˜", rank: Rank.C, hp: 300, maxHp: 300, attack: 65, description: "ì •í™•í•œ ì‚¬ê²©ì„ ê°€í•˜ëŠ” ì—˜í”„ì…ë‹ˆë‹¤.", isBoss: false }
            ],
            [Rank.B]: [
                { name: "ì•„ì´ì–¸ ê³¨ë ˜", rank: Rank.B, hp: 1000, maxHp: 1000, attack: 70, description: "ê°•ì² ë¡œ ë§Œë“¤ì–´ì§„ ê³¨ë ˜ì…ë‹ˆë‹¤.", isBoss: false },
                { name: "ì„¤ì¸", rank: Rank.B, hp: 900, maxHp: 900, attack: 80, description: "í˜¹í•œì˜ ì¶”ìœ„ë¥¼ ê²¬ë””ëŠ” ëª¬ìŠ¤í„°ì…ë‹ˆë‹¤.", isBoss: false },
                { name: "í™”ì—¼ ë„ë§ˆë±€", rank: Rank.B, hp: 800, maxHp: 800, attack: 90, description: "ëª¸ì—ì„œ ë¶ˆê¸¸ì´ ì†Ÿì•„ì˜¤ë¦…ë‹ˆë‹¤.", isBoss: false },
                { name: "ì˜¤í¬ ì£¼ìˆ ì‚¬", rank: Rank.B, hp: 600, maxHp: 600, attack: 120, description: "ì €ì£¼ë¥¼ ê±°ëŠ” ì˜¤í¬ì…ë‹ˆë‹¤.", isBoss: false },
                { name: "íƒ€ë½í•œ ì‚¬ì œ", rank: Rank.B, hp: 700, maxHp: 700, attack: 60, description: "ì–´ë‘ ì˜ í˜ìœ¼ë¡œ íšŒë³µí•©ë‹ˆë‹¤.", isBoss: false }
            ],
            [Rank.A]: [
                { name: "í•˜ì´ ì˜¤í¬ ì „ì‚¬", rank: Rank.A, hp: 2000, maxHp: 2000, attack: 120, description: "ë¶‰ì€ í”¼ë¶€ì˜ ê³ ìœ„ ì˜¤í¬ì…ë‹ˆë‹¤.", isBoss: false },
                { name: "ì„¤ì›ì˜ ë°±ê·€", rank: Rank.A, hp: 1800, maxHp: 1800, attack: 130, description: "ëˆˆë³´ë¼ ì†ì— ìˆ¨ì€ ê·€ì‹ ì…ë‹ˆë‹¤.", isBoss: false },
                { name: "ë§ˆê·¸ë§ˆ ê±°ì¸", rank: Rank.A, hp: 2500, maxHp: 2500, attack: 110, description: "ìš©ì•”ì—ì„œ íƒœì–´ë‚œ ê±°ì¸ì…ë‹ˆë‹¤.", isBoss: false },
                { name: "ì•”ì‚´ì ë‚˜ì´íŠ¸", rank: Rank.A, hp: 1500, maxHp: 1500, attack: 180, description: "ê·¸ë¦¼ì ì†ì— ìˆ¨ì–´ ê³µê²©í•©ë‹ˆë‹¤.", isBoss: false }
            ],
            [Rank.S]: [
                { name: "ë“œë˜ê³¤", rank: Rank.S, hp: 10000, maxHp: 10000, attack: 500, description: "ìµœìƒìœ„ í¬ì‹ìì…ë‹ˆë‹¤.", isBoss: true },
                { name: "ê±°ì¸ì™•", rank: Rank.S, hp: 12000, maxHp: 12000, attack: 450, description: "ëª¨ë“  ê²ƒì„ ì§“ë°ŸëŠ” ì™•ì…ë‹ˆë‹¤.", isBoss: true }
            ]
        };

        const generateDungeonScenarioLocal = (rank, theme) => {
            const base = `${rank}ê¸‰ ê²Œì´íŠ¸ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤.`;
            const themeDesc = theme ? `${theme}ì˜ ì°¨ê°€ìš´ ê³µê¸°ê°€ í”¼ë¶€ë¥¼ ìŠ¤ì¹©ë‹ˆë‹¤.` : "ì–´ë‘ ì´ ì§™ê²Œ ê¹”ë ¤ ìˆìŠµë‹ˆë‹¤.";
            const danger = "ì–´ë””ì„ ê°€ ëª¬ìŠ¤í„°ì˜ ê¸°ì²™ì´ ëŠê»´ì§‘ë‹ˆë‹¤.";
            return `${base} ${themeDesc} ${danger}`;
        };

        const generateEnemyLocal = (rank, specificName) => {
            if (specificName) {
                let hp = 100, atk = 10;
                if (rank === Rank.C) { hp = 800; atk = 60; }
                if (rank === Rank.A) { hp = 4000; atk = 200; }
                if (rank === Rank.S) { hp = 20000; atk = 1000; }
                return { name: specificName, rank, hp, maxHp: hp, attack: atk, description: "ë˜ì „ì˜ ì£¼ì¸ì…ë‹ˆë‹¤.", isBoss: true };
            }
            const candidates = ENEMIES_BY_RANK[rank] || ENEMIES_BY_RANK[Rank.E];
            const template = candidates[Math.floor(Math.random() * candidates.length)];
            const variance = 0.9 + Math.random() * 0.2;
            const finalHp = Math.floor(template.maxHp * variance);
            const finalAtk = Math.floor(template.attack * variance);
            return { ...template, hp: finalHp, maxHp: finalHp, attack: finalAtk };
        };

        const SHOP_ITEMS_RAW = [
            { id: 'hp_potion_s', name: 'ì†Œí˜• HP í¬ì…˜', type: 'CONSUMABLE', description: 'ì²´ë ¥ì„ 50 íšŒë³µí•©ë‹ˆë‹¤.', price: 100, effectValue: 50, count: 1 },
            { id: 'hp_potion_m', name: 'ì¤‘í˜• HP í¬ì…˜', type: 'CONSUMABLE', description: 'ì²´ë ¥ì„ 200 íšŒë³µí•©ë‹ˆë‹¤.', price: 300, effectValue: 200, count: 1 },
            { id: 'hp_potion_l', name: 'ëŒ€í˜• HP í¬ì…˜', type: 'CONSUMABLE', description: 'ì²´ë ¥ì„ 500 íšŒë³µí•©ë‹ˆë‹¤.', price: 800, effectValue: 500, count: 1 },
            { id: 'hp_potion_x', name: 'ì´ˆëŒ€í˜• HP í¬ì…˜', type: 'CONSUMABLE', description: 'ì²´ë ¥ì„ 1000 íšŒë³µí•©ë‹ˆë‹¤.', price: 2000, effectValue: 1000, count: 1 },
            { id: 'mp_potion_s', name: 'ì†Œí˜• MP í¬ì…˜', type: 'CONSUMABLE', description: 'ë§ˆë ¥ì„ 30 íšŒë³µí•©ë‹ˆë‹¤.', price: 100, effectValue: 30, count: 1 },
            { id: 'mp_potion_m', name: 'ì¤‘í˜• MP í¬ì…˜', type: 'CONSUMABLE', description: 'ë§ˆë ¥ì„ 100 íšŒë³µí•©ë‹ˆë‹¤.', price: 300, effectValue: 100, count: 1 },
            { id: 'mp_potion_l', name: 'ëŒ€í˜• MP í¬ì…˜', type: 'CONSUMABLE', description: 'ë§ˆë ¥ì„ 300 íšŒë³µí•©ë‹ˆë‹¤.', price: 800, effectValue: 300, count: 1 },
            { id: 'elixir', name: 'ì—˜ë¦­ì„œ', type: 'CONSUMABLE', description: 'ì²´ë ¥ê³¼ ë§ˆë ¥ì„ ì™„ì „íˆ íšŒë³µí•©ë‹ˆë‹¤.', price: 5000, effectValue: 9999, count: 1 },
            { id: 'iron_sword', name: 'ê°•ì²  ê²€', type: 'WEAPON', slot: 'WEAPON', description: 'ê¸°ë³¸ì ì¸ ê²€. (ê³µê²©ë ¥ +5)', price: 1000, effectValue: 5 },
            { id: 'knight_dagger', name: 'ê¸°ì‚¬ì˜ ë‹¨ê²€', type: 'WEAPON', slot: 'WEAPON', description: 'ì˜ˆë¦¬í•œ ë‹¨ê²€. (ê³µê²©ë ¥ +10)', price: 5000, effectValue: 10 },
            { id: 'steel_dagger', name: 'ì •ë°€í•œ ê°•ì²  ë‹¨ê²€', type: 'WEAPON', slot: 'WEAPON', description: 'ìˆ™ë ¨ìë¥¼ ìœ„í•œ ë‹¨ê²€. (ê³µê²©ë ¥ +15)', price: 8000, effectValue: 15 },
            { id: 'orc_axe', name: 'ì˜¤í¬ ëŒ€ì¥êµ°ì˜ ë„ë¼', type: 'WEAPON', slot: 'WEAPON', description: 'íŒŒê´´ë ¥ì´ ë›°ì–´ë‚©ë‹ˆë‹¤. (ê³µê²©ë ¥ +25)', price: 15000, effectValue: 25 },
            { id: 'knight_killer', name: 'ë‚˜ì´íŠ¸ í‚¬ëŸ¬', type: 'WEAPON', slot: 'WEAPON', description: 'ê°‘ì˜·ì„ ëš«ëŠ” ë‹¨ê²€. (ê³µê²©ë ¥ +35)', price: 30000, effectValue: 35 },
            { id: 'magic_sword', name: 'ë§ˆë ¥ ê¹ƒë“  ì¥ê²€', type: 'WEAPON', slot: 'WEAPON', description: 'ë§ˆë ¥ì´ íë¥´ëŠ” ê²€. (ê³µê²©ë ¥ +50)', price: 60000, effectValue: 50 },
            { id: 'baruka_dagger', name: 'ë°”ë£¨ì¹´ì˜ ë‹¨ê²€', type: 'WEAPON', slot: 'WEAPON', description: 'ë¯¼ì²©í•¨ì„ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤. (ê³µê²©ë ¥ +75)', price: 120000, effectValue: 75 },
            { id: 'demon_longsword', name: 'ì•…ë§ˆì™•ì˜ ì¥ê²€', type: 'WEAPON', slot: 'WEAPON', description: 'ì „ìœ¨ì´ ëŠê»´ì§€ëŠ” ê²€. (ê³µê²©ë ¥ +120)', price: 250000, effectValue: 120 },
            { id: 'kamish_wrath', name: 'ì¹´ë¯¸ì‰¬ì˜ ë¶„ë…¸', type: 'WEAPON', slot: 'WEAPON', description: 'ìš©ì˜ ë¼ˆë¡œ ë§Œë“  ìµœê°•ì˜ ë‹¨ê²€. (ê³µê²©ë ¥ +300)', price: 1000000, effectValue: 300 },
            { id: 'leather_armor', name: 'ê°€ì£½ ê°‘ì˜·', type: 'ARMOR', slot: 'BODY', description: 'í™œë™í•˜ê¸° í¸í•œ ê°‘ì˜·. (ë°©ì–´ë ¥ +5)', price: 1500, effectValue: 5 },
            { id: 'hard_leather', name: 'ê²½í™” ê°€ì£½ ê°‘ì˜·', type: 'ARMOR', slot: 'BODY', description: 'ë‹¨ë‹¨í•˜ê²Œ ê°€ê³µëœ ê°€ì£½. (ë°©ì–´ë ¥ +10)', price: 3000, effectValue: 10 },
            { id: 'chainmail', name: 'ì‚¬ìŠ¬ ê°‘ì˜·', type: 'ARMOR', slot: 'BODY', description: 'ë² ê¸° ê³µê²©ì„ ë§‰ì•„ì¤ë‹ˆë‹¤. (ë°©ì–´ë ¥ +18)', price: 7500, effectValue: 18 },
            { id: 'plate_armor', name: 'íŒê¸ˆ ê°‘ì˜·', type: 'ARMOR', slot: 'BODY', description: 'ë‹¨ë‹¨í•œ ê°•ì²  ê°‘ì˜·. (ë°©ì–´ë ¥ +30)', price: 25000, effectValue: 30 },
            { id: 'knight_heavy', name: 'ê¸°ì‚¬ë‹¨ì¥ì˜ ì¤‘ê°‘', type: 'ARMOR', slot: 'BODY', description: 'ê¸°ì‚¬ë‹¨ì¥ì´ ì…ë˜ ê°‘ì˜·. (ë°©ì–´ë ¥ +45)', price: 50000, effectValue: 45 },
            { id: 'commander_coat', name: 'ì‚¬ë ¹ê´€ì˜ ì½”íŠ¸', type: 'ARMOR', slot: 'BODY', description: 'ë§ˆë²• ì €í•­ë ¥ì´ ìˆìŠµë‹ˆë‹¤. (ë°©ì–´ë ¥ +60)', price: 100000, effectValue: 60 },
            { id: 'dragon_scale', name: 'ìš©ë¹„ëŠ˜ ê°‘ì˜·', type: 'ARMOR', slot: 'BODY', description: 'ëš«ì„ ìˆ˜ ì—†ëŠ” ì ˆëŒ€ ë°©ì–´. (ë°©ì–´ë ¥ +150)', price: 500000, effectValue: 150 },
            { id: 'high_orc_helm', name: 'í•˜ì´ì˜¤í¬ì˜ íˆ¬êµ¬', type: 'ARMOR', slot: 'HEAD', description: 'ìœ„ì••ì ì¸ íˆ¬êµ¬. (ë°©ì–´ë ¥ +20)', price: 35000, effectValue: 20 },
            { id: 'ring_str', name: 'í˜ì˜ ë°˜ì§€', type: 'WEAPON', slot: 'ACCESSORY', description: 'ì°©ìš© ì‹œ í˜ì´ ì†ŸìŠµë‹ˆë‹¤. (ê³µê²©ë ¥ +10)', price: 20000, effectValue: 10 },
            { id: 'neck_def', name: 'ìˆ˜í˜¸ì˜ ëª©ê±¸ì´', type: 'ARMOR', slot: 'ACCESSORY', description: 'ì°©ìš© ì‹œ ë³´í˜¸ë§‰ ìƒì„±. (ë°©ì–´ë ¥ +15)', price: 20000, effectValue: 15 },
        ];
        const SHOP_ITEMS = SHOP_ITEMS_RAW.sort((a, b) => a.price - b.price);

        // ActionPanel Component
        const ActionPanel = ({ player, addLog, updatePlayer, onEnemyDefeated, onPlayerDamage }) => {
            const [gameState, setGameState] = useState('IDLE');
            const [activeTab, setActiveTab] = useState('STORY');
            const [currentEnemy, setCurrentEnemy] = useState(null);
            const [lastDefeatedEnemy, setLastDefeatedEnemy] = useState(null);
            const [loading, setLoading] = useState(false);
            const [activeStoryId, setActiveStoryId] = useState(null);
            const [extractionAttempted, setExtractionAttempted] = useState(false);
            const [combatAnim, setCombatAnim] = useState('IDLE');

            const calculatePlayerDamage = (multiplier = 1) => {
                const companionBonus = player.companions.reduce((acc, curr) => acc + curr.attackBonus, 0);
                const equipmentBonus = player.inventory.filter(i => i.isEquipped && i.type === 'WEAPON').reduce((acc, curr) => acc + curr.effectValue, 0);
                const baseDmg = (player.stats.strength * 2) + (player.stats.agility) + companionBonus + equipmentBonus;
                const variance = Math.random() * 0.4 + 0.8;
                const critChance = player.stats.sense * 0.01;
                const isCrit = Math.random() < critChance;
                let damage = Math.floor(baseDmg * variance * multiplier);
                if (isCrit) damage = Math.floor(damage * 1.5);
                return { damage, isCrit };
            };

            const handleEnterDungeon = async (rank, theme) => {
                if (loading) return;
                setLoading(true);
                addLog(`${rank}ê¸‰ ê²Œì´íŠ¸ì— ì…ì¥í•©ë‹ˆë‹¤...`, 'info');
                const scenario = generateDungeonScenarioLocal(rank, theme);
                addLog(scenario, 'system');
                setTimeout(async () => {
                    const enemy = generateEnemyLocal(rank);
                    setCurrentEnemy(enemy);
                    setGameState('COMBAT');
                    setActiveStoryId(null);
                    setExtractionAttempted(false);
                    addLog(`[ê²½ê³ ] ${enemy.name}(ì´)ê°€ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!`, 'danger');
                    setLoading(false);
                }, 1500);
            };

            const handleStartStory = async (storyId) => {
                const story = STORIES[storyId];
                if (player.level < story.requiredLevel) {
                    addLog(`ë ˆë²¨ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš” ë ˆë²¨: ${story.requiredLevel})`, 'danger');
                    return;
                }
                setLoading(true);
                setActiveStoryId(storyId);
                setExtractionAttempted(false);
                addLog(`[ë©”ì¸ ìŠ¤í† ë¦¬] ${story.title} ì‹œì‘...`, 'story');
                addLog(`ì „ì„¤ì ì¸ ëª¬ìŠ¤í„°, ${story.bossName}ê°€ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!`, 'system');
                setTimeout(async () => {
                    const boss = generateEnemyLocal(story.bossRank, story.bossName);
                    boss.isBoss = true;
                    setCurrentEnemy(boss);
                    setGameState('COMBAT');
                    setLoading(false);
                }, 2000);
            };

            const handleAttack = () => {
                if (!currentEnemy) return;
                setCombatAnim('ATTACK');
                setTimeout(() => setCombatAnim('IDLE'), 200);
                const { damage, isCrit } = calculatePlayerDamage(1);
                if (isCrit) addLog(`[ì¹˜ëª…íƒ€!] ê¸‰ì†Œë¥¼ ì •í™•íˆ ê°€ê²©í–ˆìŠµë‹ˆë‹¤!`, 'danger');
                
                const newEnemyHp = currentEnemy.hp - damage;
                setCurrentEnemy({ ...currentEnemy, hp: newEnemyHp });
                
                if (player.companions.length > 0 && Math.random() > 0.7) {
                    const comp = player.companions[Math.floor(Math.random() * player.companions.length)];
                    addLog(`${comp.name}(ì´)ê°€ í•¨ê»˜ ê³µê²©í•©ë‹ˆë‹¤!`, 'info');
                }
                addLog(`${currentEnemy.name}ì—ê²Œ ${damage}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤.`, 'combat');

                if (newEnemyHp <= 0) handleVictory();
                else setTimeout(handleEnemyTurn, 800);
            };

            const handleSkillUse = (skill) => {
                if (!currentEnemy) return;
                if (player.mp < skill.mpCost) {
                    addLog("ë§ˆë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!", 'danger');
                    return;
                }
                setCombatAnim('SKILL');
                setTimeout(() => setCombatAnim('IDLE'), 500);
                updatePlayer({ mp: player.mp - skill.mpCost });

                if (skill.effect === 'heal') {
                    const healAmount = Math.floor(player.maxHp * 0.4);
                    updatePlayer({ hp: Math.min(player.maxHp, player.hp + healAmount) });
                    addLog(`[ìŠ¤í‚¬] ${skill.name} ì‚¬ìš©! ì²´ë ¥ì´ ${healAmount} íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤.`, 'gain');
                    setTimeout(handleEnemyTurn, 800);
                    return;
                }

                if (skill.damageMult) {
                    const { damage } = calculatePlayerDamage(skill.damageMult);
                    const newEnemyHp = currentEnemy.hp - damage;
                    setCurrentEnemy({ ...currentEnemy, hp: newEnemyHp });
                    addLog(`[ìŠ¤í‚¬] ${skill.name}! ${damage}ì˜ ë§‰ëŒ€í•œ í”¼í•´!`, 'danger');
                    if (newEnemyHp <= 0) handleVictory();
                    else setTimeout(handleEnemyTurn, 800);
                    return;
                }
                addLog(`[ìŠ¤í‚¬] ${skill.name} ë°œë™!`, 'info');
                setTimeout(handleEnemyTurn, 800);
            };

            const handleEnemyTurn = () => {
                if (!currentEnemy || gameState !== 'COMBAT') return;
                const armorBonus = player.inventory.filter(i => i.isEquipped && i.type === 'ARMOR').reduce((acc, curr) => acc + curr.effectValue, 0);
                const defense = (player.stats.vitality * 0.8) + armorBonus;
                const dodgeChance = Math.min(0.5, player.stats.agility * 0.005); 
                
                if (Math.random() < dodgeChance) {
                    addLog(`ë¹ ë¥¸ ëª¸ë†€ë¦¼ìœ¼ë¡œ ${currentEnemy.name}ì˜ ê³µê²©ì„ íšŒí”¼í–ˆìŠµë‹ˆë‹¤!`, 'gain');
                    return;
                }

                setCombatAnim('HIT');
                setTimeout(() => setCombatAnim('IDLE'), 500);
                const rawDmg = currentEnemy.attack;
                const finalDmg = Math.max(1, Math.floor(rawDmg - defense));
                addLog(`${currentEnemy.name}ì˜ ê³µê²©! ${finalDmg}ì˜ í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤. ${armorBonus > 0 ? `(ë°©ì–´êµ¬ íš¨ê³¼ -${armorBonus})` : ''}`, 'danger');
                onPlayerDamage(finalDmg);
            };

            const handleVictory = () => {
                if (!currentEnemy) return;
                addLog(`${currentEnemy.name}ì„(ë¥¼) ì²˜ì¹˜í–ˆìŠµë‹ˆë‹¤!`, 'gain');
                let expBase = 0, goldBase = 0;
                switch(currentEnemy.rank) {
                    case Rank.E: expBase = 20; goldBase = 100; break;
                    case Rank.D: expBase = 50; goldBase = 300; break;
                    case Rank.C: expBase = 150; goldBase = 1000; break;
                    case Rank.B: expBase = 500; goldBase = 5000; break;
                    case Rank.A: expBase = 2000; goldBase = 20000; break;
                    case Rank.S: expBase = 10000; goldBase = 100000; break;
                }
                if (currentEnemy.isBoss) {
                    expBase *= 3; goldBase *= 5;
                    addLog("ë³´ìŠ¤ ì²˜ì¹˜ ë³´ë„ˆìŠ¤ íšë“!", 'gain');
                }
                onEnemyDefeated(currentEnemy.rank, expBase, goldBase, activeStoryId !== null ? activeStoryId : undefined);
                setLastDefeatedEnemy(currentEnemy);
                setCurrentEnemy(null);
                setGameState('VICTORY');
            };

            const handleExtraction = () => {
                if (!lastDefeatedEnemy) return;
                if (extractionAttempted) { addLog("ì´ë¯¸ ì¶”ì¶œì„ ì‹œë„í–ˆìŠµë‹ˆë‹¤.", 'info'); return; }
                const skill = player.skills.find(s => s.id === 'shadow_extract');
                if (!skill) return;
                if (player.mp < skill.mpCost) { addLog("ë§ˆë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.", 'danger'); return; }

                setExtractionAttempted(true);
                updatePlayer({ mp: player.mp - skill.mpCost });
                addLog("ê·¸ë¦¼ì ì¶”ì¶œì„ ì‹œë„í•©ë‹ˆë‹¤...", 'system');
                setCombatAnim('EXTRACTION');

                const successChance = 40 + (player.stats.intelligence * 0.5);
                const roll = Math.random() * 100;
                
                setTimeout(() => {
                    setCombatAnim('IDLE');
                    if (roll < successChance) {
                        const enemyName = lastDefeatedEnemy.name;
                        let shadowName = `ê·¸ë¦¼ì ${enemyName}`;
                        let role = "ë³´ë³‘";
                        let bonusMult = 0.8; 

                        if (lastDefeatedEnemy.isBoss) {
                            shadowName = `[ì¥êµ°] ${enemyName}`; role = "ì¥êµ°"; bonusMult = 1.5;
                        } else if (/ë§ˆë²•|ì£¼ìˆ |í™”ì—¼|ì–¼ìŒ|ë©”ì´ì§€|ìœ„ìë“œ/.test(enemyName)) {
                            shadowName = enemyName.replace(/ë§ˆë²•ì‚¬|ì£¼ìˆ ì‚¬|í™”ì—¼|ì–¼ìŒ/, '').trim() + " (ë©”ì´ì§€)"; role = "ë§ˆë²•ì‚¬"; bonusMult = 1.3;
                        } else if (/ê³¨ë ˜|ë°©íŒ¨|ê±°ì¸|ì•„ì´ì–¸|ê°€ë””ì–¸/.test(enemyName)) {
                            shadowName = enemyName.replace(/ê³¨ë ˜/, '').trim() + " (ê°€ë””ì–¸)"; role = "íƒ±ì»¤"; bonusMult = 0.5;
                        } else if (/ì•”ì‚´|ëŠ‘ëŒ€|ë‹¨ê²€|ìŠ¤íŒŒì´ë”|ê·¸ë¦¼ì/.test(enemyName)) {
                            shadowName = enemyName.replace(/ì•”ì‚´ì/, '').trim() + " (ì–´ìŒ”ì‹ )"; role = "ì•”ì‚´ì"; bonusMult = 1.2;
                        } else if (/ê¸°ì‚¬|ë‚˜ì´íŠ¸|ì˜¤í¬|ë¦¬ìë“œ|ê²€ì‚¬/.test(enemyName)) {
                            shadowName = enemyName.replace(/ê¸°ì‚¬/, '').trim() + " (ë‚˜ì´íŠ¸)"; role = "ì „ì‚¬"; bonusMult = 1.0;
                        }

                        const newCompanion = {
                            id: `shadow_${Date.now()}`,
                            name: shadowName,
                            rank: lastDefeatedEnemy.rank,
                            description: `${lastDefeatedEnemy.name}ì˜ ê·¸ë¦¼ìì…ë‹ˆë‹¤.`,
                            type: 'SHADOW',
                            role: role,
                            attackBonus: Math.max(1, Math.floor(lastDefeatedEnemy.attack * bonusMult))
                        };
                        const updatedCompanions = [...player.companions, newCompanion];
                        updatePlayer({ companions: updatedCompanions });
                        addLog(`ì„±ê³µí–ˆìŠµë‹ˆë‹¤! ${newCompanion.name}(ì´)ê°€ ê·¸ë¦¼ì êµ°ë‹¨ì— í•©ë¥˜í•©ë‹ˆë‹¤.`, 'gain');
                    } else {
                        addLog("ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜í˜¼ì´ ì†Œë©¸ë˜ì—ˆìŠµë‹ˆë‹¤.", 'info');
                    }
                }, 2000);
            };

            const handleBuyItem = (item) => {
                if (player.gold < item.price) { addLog("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.", 'danger'); return; }
                const newInventory = [...player.inventory];
                if (item.type === 'CONSUMABLE') {
                    const existingItem = newInventory.find(i => i.id === item.id);
                    if (existingItem) existingItem.count = (existingItem.count || 0) + 1;
                    else newInventory.push({ ...item, count: 1 });
                } else {
                    newInventory.push({ ...item, uid: Date.now().toString() + Math.random().toString().slice(2), isEquipped: false });
                }
                updatePlayer({ gold: player.gold - item.price, inventory: newInventory });
                addLog(`${item.name}ì„(ë¥¼) êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤.`, 'gain');
            };

            const handleUseItem = (itemId) => {
                const itemIndex = player.inventory.findIndex(i => i.id === itemId);
                if (itemIndex === -1) return;
                const item = player.inventory[itemIndex];
                if (item.type !== 'CONSUMABLE') return;
                let used = false;
                if (item.id === 'elixir') {
                    updatePlayer({ hp: player.maxHp, mp: player.maxMp });
                    addLog(`${item.name} ì‚¬ìš©. ëª¨ë“  ìƒíƒœê°€ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤!`, 'gain');
                    used = true;
                } else if (item.id.includes('hp')) {
                    if (player.hp >= player.maxHp) { addLog("ì²´ë ¥ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.", 'info'); return; }
                    updatePlayer({ hp: Math.min(player.maxHp, player.hp + item.effectValue) });
                    used = true;
                } else if (item.id.includes('mp')) {
                    if (player.mp >= player.maxMp) { addLog("ë§ˆë ¥ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.", 'info'); return; }
                    updatePlayer({ mp: Math.min(player.maxMp, player.mp + item.effectValue) });
                    used = true;
                }
                if (used) {
                    const newInventory = [...player.inventory];
                    if ((item.count || 1) > 1) newInventory[itemIndex].count -= 1;
                    else newInventory.splice(itemIndex, 1);
                    updatePlayer({ inventory: newInventory });
                    addLog(`${item.name} ì‚¬ìš©.`, 'gain');
                }
            };

            if (gameState === 'COMBAT' && currentEnemy) {
                return (
                    <div className={`flex-1 flex flex-col gap-4 p-4 bg-red-900/10 border border-red-500/30 rounded-lg relative min-h-[400px] overflow-hidden transition-all duration-200
                        ${combatAnim === 'HIT' ? 'animate-damage-shake border-red-600 bg-red-900/40 shadow-[inset_0_0_50px_rgba(220,38,38,0.5)]' : ''}
                        ${combatAnim === 'SKILL' ? 'animate-skill-flash shadow-[inset_0_0_30px_rgba(59,130,246,0.3)]' : ''}
                        ${combatAnim === 'ATTACK' ? 'shadow-[inset_0_0_20px_rgba(255,255,255,0.1)]' : ''}
                    `}>
                        <div className="absolute top-2 right-4 text-red-500 font-bold text-xl tracking-wider animate-pulse z-10">COMBAT</div>
                        {combatAnim === 'ATTACK' && <div className="absolute inset-0 z-30 flex items-center justify-center pointer-events-none"><div className="w-[120%] h-1 bg-white shadow-[0_0_15px_white] rotate-45 animate-pulse"></div></div>}
                        {combatAnim === 'EXTRACTION' && <div className="absolute inset-0 z-40 flex items-center justify-center pointer-events-none bg-purple-900/60 animate-pulse"><span className="text-6xl">ğŸ‘»</span></div>}
                        
                        <div className={`flex flex-col items-center justify-center flex-1 py-4 relative z-10 ${combatAnim === 'HIT' ? 'scale-110 brightness-150' : ''}`}>
                            <div className="text-6xl mb-4 animate-bounce">{currentEnemy.isBoss ? 'ğŸ‘¹' : 'ğŸ‘¾'}</div>
                            <h3 className="text-2xl font-bold text-red-400">{currentEnemy.name} <span className="text-sm text-gray-400">({currentEnemy.rank}ê¸‰)</span></h3>
                            <div className="w-full max-w-md mt-4 px-4">
                                <div className="flex justify-between text-sm text-red-300 mb-1">
                                    <span>HP</span>
                                    <span>{Math.max(0, currentEnemy.hp)} / {currentEnemy.maxHp}</span>
                                </div>
                                <div className="h-4 bg-gray-900 rounded-full border border-red-900/50 overflow-hidden relative">
                                    <div className="h-full bg-red-600 transition-all duration-200" style={{ width: `${Math.max(0, (currentEnemy.hp / currentEnemy.maxHp) * 100)}%` }}></div>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-2 mt-auto">
                            <button onClick={handleAttack} className="p-3 bg-gray-800 hover:bg-red-900 border border-gray-600 rounded text-white font-bold">
                                âš”ï¸ ê¸°ë³¸ ê³µê²©
                            </button>
                            {player.skills.map(skill => (
                                skill.effect !== 'summon' && (
                                <button key={skill.id} onClick={() => handleSkillUse(skill)} disabled={player.mp < skill.mpCost} className="p-3 bg-gray-800 hover:bg-blue-900 border border-gray-600 rounded text-white disabled:opacity-30">
                                    <span className="font-bold">{skill.name}</span> <span className="text-xs text-blue-300">({skill.mpCost} MP)</span>
                                </button>
                                )
                            ))}
                            <div className="col-span-2 flex gap-2 mt-2">
                                {player.inventory.filter(i => i.type === 'CONSUMABLE').map((item) => (
                                    <button key={item.id} onClick={() => handleUseItem(item.id)} className="flex-1 py-2 px-3 bg-gray-800 hover:bg-green-900 border border-gray-600 rounded text-xs text-gray-300 flex justify-between">
                                        <span>ğŸ’Š {item.name}</span><span>x{item.count}</span>
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => { addLog("ë„ë§ì³¤ìŠµë‹ˆë‹¤!", 'info'); setGameState('IDLE'); setCurrentEnemy(null); }} className="col-span-2 p-2 text-xs text-gray-500 hover:text-white mt-2">
                                ğŸƒ ë„ë§ê°€ê¸°
                            </button>
                        </div>
                    </div>
                );
            }

            if (gameState === 'VICTORY' && lastDefeatedEnemy) {
                return (
                    <div className="flex-1 flex flex-col items-center justify-center gap-6 p-6 bg-blue-900/10 border border-system-blue/50 rounded-lg">
                        <div className="text-4xl font-bold text-system-blue animate-pulse">VICTORY</div>
                        <div className="text-center">
                            <p className="text-xl text-gray-300 mb-2">{lastDefeatedEnemy.name} ì²˜ì¹˜!</p>
                            <p className="text-sm text-gray-500">ê²½í—˜ì¹˜ì™€ ê³¨ë“œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.</p>
                        </div>
                        <div className="flex flex-col gap-3 w-full max-w-xs">
                            {player.skills.some(s => s.id === 'shadow_extract') && (
                                <button onClick={handleExtraction} disabled={extractionAttempted || player.mp < 100} className={`py-4 px-6 rounded border border-purple-500 text-purple-300 font-bold ${extractionAttempted ? 'bg-gray-900 opacity-50' : 'bg-purple-900/30 hover:bg-purple-900/60'}`}>
                                    ê·¸ë¦¼ì ì¶”ì¶œ (MP 100)
                                </button>
                            )}
                            <button onClick={() => { setGameState('IDLE'); setLastDefeatedEnemy(null); setExtractionAttempted(false); setActiveStoryId(null); }} className="py-3 px-6 bg-gray-800 hover:bg-gray-700 rounded text-white font-bold border border-gray-600">
                                ëŒì•„ê°€ê¸°
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex-1 flex flex-col gap-4">
                    <div className="flex gap-2 bg-system-panel p-2 rounded border border-gray-800">
                        <button onClick={() => { if(player.hp < 10) return; updatePlayer({ hp: player.hp - 5, currentExp: player.currentExp + 10 }); addLog("í›ˆë ¨ì„ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤. (+10 EXP)", 'gain'); }} className="flex-1 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm">ğŸ’ª í›ˆë ¨í•˜ê¸°</button>
                        <button onClick={() => { updatePlayer({ hp: Math.min(player.maxHp, player.hp + player.maxHp*0.5), mp: Math.min(player.maxMp, player.mp + player.maxMp*0.5) }); addLog("íœ´ì‹ì„ ì·¨í–ˆìŠµë‹ˆë‹¤.", 'gain'); }} className="flex-1 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm">ğŸ’¤ íœ´ì‹í•˜ê¸°</button>
                    </div>

                    <div className="flex border-b border-gray-700">
                        <button onClick={() => setActiveTab('STORY')} className={`flex-1 py-3 font-bold ${activeTab === 'STORY' ? 'text-system-blue border-b-2 border-system-blue' : 'text-gray-500'}`}>ìŠ¤í† ë¦¬</button>
                        <button onClick={() => setActiveTab('DUNGEON')} className={`flex-1 py-3 font-bold ${activeTab === 'DUNGEON' ? 'text-system-blue border-b-2 border-system-blue' : 'text-gray-500'}`}>ë˜ì „</button>
                        {player.level >= 5 && <button onClick={() => setActiveTab('SHOP')} className={`flex-1 py-3 font-bold ${activeTab === 'SHOP' ? 'text-yellow-500 border-b-2 border-yellow-500' : 'text-gray-500'}`}>ìƒì </button>}
                    </div>

                    <div className="flex-1 overflow-y-auto min-h-[300px]">
                        {activeTab === 'STORY' && (
                            <div className="space-y-3">
                                {STORIES.map((story, index) => {
                                    const isLocked = index > player.storyStage;
                                    const isCompleted = index < player.storyStage;
                                    return (
                                        <div key={story.id} className={`relative p-4 rounded border ${isLocked ? 'border-gray-800 bg-gray-900/50 opacity-50' : isCompleted ? 'border-green-900 bg-green-900/10' : 'border-system-blue bg-system-blue/10'}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <h4 className={`font-bold ${isCompleted ? 'text-green-500' : isLocked ? 'text-gray-500' : 'text-system-blue'}`}>{story.title}</h4>
                                                <span className="text-xs bg-gray-900 px-2 py-1 rounded text-gray-300">Lv.{story.requiredLevel}+</span>
                                            </div>
                                            <p className="text-sm text-gray-400 mb-4">{story.description}</p>
                                            {!isCompleted && !isLocked && (
                                                <button onClick={() => handleStartStory(story.id)} className="w-full py-2 bg-system-blue hover:bg-blue-600 text-black font-bold rounded">ìŠ¤í† ë¦¬ ì‹œì‘</button>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        {activeTab === 'DUNGEON' && (
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                {loading ? <div className="col-span-2 text-center py-10 text-system-blue animate-pulse">ë˜ì „ íƒìƒ‰ ì¤‘...</div> :
                                [
                                    { r: Rank.E, t: "ì§€í•˜ ìˆ˜ë¡œ" },
                                    { r: Rank.D, t: "ê³ ë¸”ë¦° ìˆ²" },
                                    { r: Rank.C, t: "ì˜¤í¬ì˜ ëŠªì§€ëŒ€" },
                                    { r: Rank.B, t: "ê³¨ë ˜ì˜ ê´‘ì‚°" },
                                    { r: Rank.B, t: "ì–¼ìŒ ë™êµ´" },
                                    { r: Rank.A, t: "ì„¤ì› (Red Gate)" },
                                    { r: Rank.A, t: "í™”ì‚° ì§€ëŒ€" },
                                    { r: Rank.S, t: "ì œì£¼ë„ (ê°œë¯¸êµ´)" }
                                ].map((dungeon, idx) => (
                                    <button key={idx} onClick={() => handleEnterDungeon(dungeon.r, dungeon.t)} className="p-4 text-left rounded border border-gray-700 bg-gray-800/30 hover:bg-gray-700 hover:border-system-blue group">
                                        <div className="font-bold text-gray-300 group-hover:text-system-blue">{dungeon.r}ê¸‰ - {dungeon.t}</div>
                                        <div className="text-xs text-gray-500">ì…ì¥í•˜ê¸° &rarr;</div>
                                    </button>
                                ))}
                            </div>
                        )}
                        {activeTab === 'SHOP' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 p-2">
                                {SHOP_ITEMS.map((item) => (
                                    <div key={item.id} className="flex justify-between items-center p-3 bg-gray-900/60 border border-gray-700 rounded hover:border-yellow-600">
                                        <div>
                                            <div className="font-bold text-white">{item.name}</div>
                                            <div className="text-xs text-gray-500">{item.description}</div>
                                        </div>
                                        <button onClick={() => handleBuyItem(item)} className="bg-gray-800 hover:bg-yellow-800 px-3 py-1 rounded text-yellow-400 font-mono text-sm border border-gray-600">
                                            {item.price} G
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [gameStarted, setGameStarted] = useState(false);
            const [playerNameInput, setPlayerNameInput] = useState("");
            const [logs, setLogs] = useState([]);
            const [isLevelUp, setIsLevelUp] = useState(false);
            const [selectedSkillForUpgrade, setSelectedSkillForUpgrade] = useState(null);
            const [isCodeModalOpen, setIsCodeModalOpen] = useState(false);
            const [codeInput, setCodeInput] = useState("");

            const [player, setPlayer] = useState({
                name: "",
                level: 1,
                currentExp: 0,
                maxExp: 100,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                gold: 0,
                stats: { strength: 10, agility: 10, sense: 10, vitality: 10, intelligence: 10 },
                statPoints: 0,
                job: PlayerClass.NONE,
                title: "ìƒˆë‚´ê¸° í—Œí„°",
                skills: [{ id: 'sprint', name: 'ì „ë ¥ ì§ˆì£¼', description: 'ì´ë™ ì†ë„ê°€ ë¹¨ë¼ì§‘ë‹ˆë‹¤.', mpCost: 5, cooldown: 3, level: 1 }],
                companions: [],
                inventory: [],
                storyStage: 0
            });

            const addLog = useCallback((text, type = 'info') => {
                setLogs(prev => [...prev, { id: Date.now() + Math.random(), text, type, timestamp: Date.now() }].slice(-50));
            }, []);

            useEffect(() => {
                if (!gameStarted) return;
                if (player.currentExp >= player.maxExp) {
                    const leftoverExp = player.currentExp - player.maxExp;
                    const newLevel = player.level + 1;
                    const hpGrowth = 20 + (player.stats.vitality * 2);
                    const mpGrowth = 10 + (player.stats.intelligence * 2);
                    
                    let newSkills = [...player.skills];
                    if (newLevel === 5 && !newSkills.find(s => s.id === 'vital_strike')) {
                        newSkills.push({ id: 'vital_strike', name: 'ê¸‰ì†Œ ì°Œë¥´ê¸°', description: 'ì ì˜ ì•½ì ì„ ê³µê²©í•©ë‹ˆë‹¤. (200%)', mpCost: 15, cooldown: 2, damageMult: 2.0, level: 1 });
                        addLog("ã€ìŠ¤í‚¬ íšë“ã€‘ 'ê¸‰ì†Œ ì°Œë¥´ê¸°'ë¥¼ ë°°ì› ìŠµë‹ˆë‹¤.", 'system');
                    }
                    if ((newLevel >= 20 || player.job === PlayerClass.NECROMANCER) && !newSkills.find(s => s.id === 'shadow_extract')) {
                        newSkills.push({ id: 'shadow_extract', name: 'ê·¸ë¦¼ì ì¶”ì¶œ', description: 'ì“°ëŸ¬ì§„ ì ì„ ë³‘ì‚¬ë¡œ ë§Œë“­ë‹ˆë‹¤.', mpCost: 100, cooldown: 0, effect: 'summon', level: 1 });
                        addLog("ã€ìŠ¤í‚¬ íšë“ã€‘ 'ê·¸ë¦¼ì ì¶”ì¶œ'ì„ ë°°ì› ìŠµë‹ˆë‹¤.", 'system');
                    }

                    setPlayer(prev => ({
                        ...prev,
                        level: newLevel,
                        currentExp: leftoverExp,
                        maxExp: Math.floor(prev.maxExp * 1.3),
                        maxHp: prev.maxHp + hpGrowth,
                        hp: prev.maxHp + hpGrowth,
                        maxMp: prev.maxMp + mpGrowth,
                        mp: prev.maxMp + mpGrowth,
                        statPoints: prev.statPoints + 3,
                        skills: newSkills
                    }));
                    setIsLevelUp(true);
                    addLog(`ë ˆë²¨ ì—…! Lv.${newLevel} ë‹¬ì„±!`, 'system');
                }
            }, [player.currentExp, player.maxExp, gameStarted, addLog, player.stats]);

            const handleStartGame = () => {
                if (!playerNameInput.trim()) return;
                setPlayer(prev => ({ ...prev, name: playerNameInput }));
                setGameStarted(true);
                setTimeout(() => {
                    addLog("ì‹œìŠ¤í…œê³¼ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.", 'system');
                    addLog(`í”Œë ˆì´ì–´ '${playerNameInput}'ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤.`, 'system');
                }, 100);
            };

            const handleEnemyDefeated = (rank, exp, gold, storyId) => {
                let updates = { currentExp: player.currentExp + exp, gold: player.gold + gold };
                if (storyId !== undefined && storyId === player.storyStage) {
                    addLog(`ã€ìŠ¤í† ë¦¬ ì™„ë£Œã€‘ ì±•í„° ${storyId + 1} í´ë¦¬ì–´!`, 'system');
                    updates.storyStage = player.storyStage + 1;
                    if (storyId === 1) { 
                        updates.job = PlayerClass.NECROMANCER;
                        updates.title = "ê·¸ë¦¼ì êµ°ì£¼";
                        addLog("ã€ì „ì§ã€‘ ë„¤í¬ë¡œë§¨ì„œë¡œ ì „ì§í–ˆìŠµë‹ˆë‹¤.", 'system');
                        const igris = { id: 'igris', name: 'ì´ê·¸ë¦¬ìŠ¤', rank: Rank.A, description: 'í•ë¹›ì˜ ê¸°ì‚¬ë‹¨ì¥', type: 'SHADOW', role: 'ê¸°ì‚¬ë‹¨ì¥', attackBonus: 50 };
                        updates.companions = [...player.companions, igris];
                        addLog("ê·¸ë¦¼ì ë³‘ì‚¬ 'ì´ê·¸ë¦¬ìŠ¤'ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.", 'gain');
                    }
                    if (storyId === 2) {
                        const iron = { id: 'iron', name: 'ì•„ì´ì–¸', rank: Rank.A, description: 'ê°•ì² ì˜ ìœ¡ì²´', type: 'SHADOW', role: 'íƒ±ì»¤', attackBonus: 40 };
                        updates.companions = [...(updates.companions || player.companions), iron];
                        addLog("ê·¸ë¦¼ì ë³‘ì‚¬ 'ì•„ì´ì–¸'ì„ íšë“í–ˆìŠµë‹ˆë‹¤.", 'gain');
                    }
                    if (storyId === 4) {
                        const beru = { id: 'beru', name: 'ë² ë¥´', rank: Rank.S, description: 'ê°œë¯¸ì˜ ì™•', type: 'SHADOW', role: 'êµ°ë‹¨ì¥', attackBonus: 200 };
                        updates.companions = [...(updates.companions || player.companions), beru];
                        addLog("ê·¸ë¦¼ì ë³‘ì‚¬ 'ë² ë¥´'ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.", 'gain');
                    }
                }
                setPlayer(prev => ({ ...prev, ...updates }));
            };

            const handleToggleEquip = (item) => {
                if (item.type === 'CONSUMABLE') return;
                setPlayer(prev => {
                    const newInventory = [...prev.inventory];
                    const targetIndex = newInventory.findIndex(i => i.uid === item.uid);
                    if (targetIndex === -1) return prev;
                    const target = newInventory[targetIndex];
                    if (target.isEquipped) {
                        newInventory[targetIndex].isEquipped = false;
                        addLog(`${target.name} í•´ì œ.`, 'info');
                    } else {
                        newInventory.forEach(i => { if (i.slot === target.slot) i.isEquipped = false; });
                        newInventory[targetIndex].isEquipped = true;
                        addLog(`${target.name} ì¥ì°©.`, 'gain');
                    }
                    return { ...prev, inventory: newInventory };
                });
            };

            const handleSubmitCode = () => {
                setIsCodeModalOpen(false);
                const code = codeInput.trim();
                if (code === '1014') {
                    setPlayer(prev => ({ ...prev, gold: prev.gold + 50000 }));
                    addLog("ê´€ë¦¬ì ì½”ë“œ: 50,000G ì§€ê¸‰.", 'gain');
                } else if (code === '3237') {
                     const kamish = { id: 'kamish', name: 'ê·¸ë¦¼ì ì¹´ë¯¸ì‰¬', rank: Rank.S, description: 'íŒŒë©¸ì˜ ìš©', type: 'SHADOW', role: 'ë“œë˜ê³¤', attackBonus: 500 };
                     if (!player.companions.find(c => c.id === 'kamish')) {
                        setPlayer(prev => ({ ...prev, companions: [...prev.companions, kamish] }));
                        addLog("ê´€ë¦¬ì ì½”ë“œ: ê·¸ë¦¼ì 'ì¹´ë¯¸ì‰¬' ì†Œí™˜.", 'gain');
                     }
                } else if (code === '6717') {
                    const iaido = { id: 'iaido', name: 'ë°œë„ìˆ ', description: 'ë³´ì´ì§€ ì•ŠëŠ” ì†ë„ë¡œ ë² ì–´ëƒ…ë‹ˆë‹¤.', mpCost: 40, cooldown: 2, damageMult: 3.5, level: 1 };
                    if (!player.skills.find(s => s.id === 'iaido')) {
                        setPlayer(prev => ({ ...prev, skills: [...prev.skills, iaido] }));
                        addLog("ê´€ë¦¬ì ì½”ë“œ: ìŠ¤í‚¬ 'ë°œë„ìˆ ' ìŠµë“.", 'gain');
                    }
                } else {
                    addLog("ìœ íš¨í•˜ì§€ ì•Šì€ ì½”ë“œ.", 'info');
                }
            };

            const handleUpgradeSkill = (type) => {
                if (!selectedSkillForUpgrade) return;
                const skillIndex = player.skills.findIndex(s => s.id === selectedSkillForUpgrade.id);
                if (skillIndex === -1) return;
                const currentSkill = player.skills[skillIndex];
                const cost = Math.floor(500 * currentSkill.level);
                if (player.gold < cost) { addLog(`ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${cost}G)`, 'danger'); return; }

                let updatedSkill = { ...currentSkill, level: currentSkill.level + 1 };
                let upgradedText = "";
                if (type === 'damage' && updatedSkill.damageMult) {
                    updatedSkill.damageMult = parseFloat((updatedSkill.damageMult + 0.2).toFixed(1)); upgradedText = "ê³µê²©ë ¥ ì¦ê°€";
                } else if (type === 'cost') {
                    updatedSkill.mpCost = Math.max(1, updatedSkill.mpCost - 2); upgradedText = "MP ì†Œëª¨ ê°ì†Œ";
                } else if (type === 'cooldown') {
                    updatedSkill.cooldown = Math.max(0, updatedSkill.cooldown - 1); upgradedText = "ì¬ì‚¬ìš© ëŒ€ê¸°ì‹œê°„ ê°ì†Œ";
                }
                const newSkills = [...player.skills];
                newSkills[skillIndex] = updatedSkill;
                setPlayer(prev => ({ ...prev, gold: prev.gold - cost, skills: newSkills }));
                addLog(`ã€ìŠ¤í‚¬ ê°•í™”ã€‘ ${updatedSkill.name} Lv.${updatedSkill.level} (${upgradedText})`, 'gain');
                setSelectedSkillForUpgrade(null);
            };

            if (!gameStarted) {
                return (
                    <div className="min-h-screen w-full bg-black text-system-text flex flex-col items-center justify-center p-4 relative overflow-hidden font-sans">
                        <div className="absolute inset-0 bg-[linear-gradient(rgba(0,168,255,0.05)_1px,transparent_1px),linear-gradient(90deg,rgba(0,168,255,0.05)_1px,transparent_1px)] bg-[size:40px_40px]"></div>
                        <div className="z-10 bg-system-panel/90 border border-system-blue p-8 rounded-lg shadow-[0_0_30px_rgba(0,168,255,0.3)] max-w-md w-full text-center">
                            <h1 className="text-4xl font-bold text-system-blue tracking-[0.2em] mb-8">SYSTEM</h1>
                            <input type="text" value={playerNameInput} onChange={(e) => setPlayerNameInput(e.target.value)} placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" className="w-full bg-black/50 border border-gray-700 focus:border-system-blue rounded p-4 text-white outline-none mb-8 text-lg" autoFocus onKeyDown={(e) => e.key === 'Enter' && handleStartGame()} />
                            <button onClick={handleStartGame} disabled={!playerNameInput.trim()} className="w-full bg-system-blue hover:bg-blue-600 text-black font-bold py-4 rounded disabled:opacity-30">ë“±ë¡ ì™„ë£Œ</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen w-full bg-system-dark text-system-text flex flex-col p-2 lg:p-6 relative">
                    <div className="fixed inset-0 pointer-events-none z-0 opacity-20 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-blue-900/20 via-black to-black"></div>
                    
                    <header className="relative z-10 flex justify-between items-center mb-6 border-b border-system-blue/30 pb-4 shrink-0">
                        <h1 className="text-xl lg:text-3xl font-bold tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-system-blue to-white drop-shadow-[0_0_10px_rgba(0,168,255,0.8)]">
                            SOLO LEVELING <span className="text-xs align-top text-system-blue">SYSTEM</span>
                        </h1>
                        <div className="text-yellow-500 font-bold font-mono">GOLD: {player.gold.toLocaleString()}</div>
                    </header>

                    <main className="relative z-10 flex flex-col lg:flex-row gap-6 flex-1 max-w-7xl mx-auto w-full">
                        <StatusWindow 
                            player={player} 
                            onIncreaseStat={(stat) => { if (player.statPoints > 0) setPlayer(prev => ({ ...prev, stats: { ...prev.stats, [stat]: prev.stats[stat] + 1 }, statPoints: prev.statPoints - 1 })); }} 
                            onToggleEquip={handleToggleEquip}
                            onOpenCodeModal={() => { setIsCodeModalOpen(true); setCodeInput(""); }}
                        />
                        <div className="flex-1 flex flex-col gap-6 min-w-0">
                            <GameLog logs={logs} />
                            <ActionPanel 
                                player={player} 
                                addLog={addLog} 
                                updatePlayer={(updates) => setPlayer(prev => ({ ...prev, ...updates }))}
                                onEnemyDefeated={handleEnemyDefeated}
                                onPlayerDamage={(dmg) => {
                                    const newHp = player.hp - dmg;
                                    setPlayer(prev => ({ ...prev, hp: newHp }));
                                    if (newHp <= 0) {
                                        addLog("íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤. ê²½í—˜ì¹˜ì™€ ê³¨ë“œë¥¼ ì¼ë¶€ ìƒìŠµë‹ˆë‹¤.", 'danger');
                                        setPlayer(prev => ({ ...prev, hp: Math.floor(prev.maxHp * 0.1), currentExp: Math.floor(prev.currentExp * 0.7), gold: Math.floor(prev.gold * 0.8) }));
                                    }
                                }}
                            />
                        </div>
                    </main>

                    {isLevelUp && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                            <div className="bg-system-panel border-2 border-yellow-400 p-8 rounded-lg text-center shadow-[0_0_50px_rgba(250,204,21,0.4)]">
                                <h2 className="text-3xl font-bold text-yellow-400 mb-2 animate-bounce">LEVEL UP!</h2>
                                <button onClick={() => setIsLevelUp(false)} className="mt-4 px-6 py-2 bg-yellow-500 text-black font-bold rounded">í™•ì¸</button>
                            </div>
                        </div>
                    )}
                    
                    {isCodeModalOpen && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
                             <div className="bg-system-panel border border-system-blue p-6 rounded-lg w-full max-w-sm">
                                 <h2 className="text-system-blue font-bold mb-4">ADMINISTRATOR CODE</h2>
                                 <input type="password" value={codeInput} onChange={(e) => setCodeInput(e.target.value)} className="w-full bg-black border border-gray-700 text-center text-lg text-white p-2 mb-4" autoFocus />
                                 <div className="flex gap-2">
                                     <button onClick={handleSubmitCode} className="flex-1 bg-system-blue text-black font-bold py-2 rounded">SUBMIT</button>
                                     <button onClick={() => setIsCodeModalOpen(false)} className="flex-1 bg-gray-800 text-gray-300 py-2 rounded">CANCEL</button>
                                 </div>
                             </div>
                        </div>
                    )}
                    
                    {selectedSkillForUpgrade && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                            <div className="bg-system-panel border border-system-blue p-6 rounded-lg max-w-md w-full relative">
                                <button onClick={() => setSelectedSkillForUpgrade(null)} className="absolute top-2 right-4 text-gray-500">âœ•</button>
                                <h2 className="text-xl font-bold text-system-blue mb-1">SKILL EVOLUTION</h2>
                                <div className="space-y-3 mt-4">
                                    <div className="text-center mb-4">
                                        <span className="text-gray-400 text-xs">í•„ìš” ê³¨ë“œ</span>
                                        <div className="text-yellow-400 font-bold font-mono text-xl">{Math.floor(500 * selectedSkillForUpgrade.level)} G</div>
                                    </div>
                                    {selectedSkillForUpgrade.damageMult && <button onClick={() => handleUpgradeSkill('damage')} className="w-full p-3 bg-gray-800 border border-gray-600 rounded flex justify-between"><span>íŒŒê´´ë ¥ ê°•í™”</span><span>âš”ï¸</span></button>}
                                    <button onClick={() => handleUpgradeSkill('cost')} disabled={selectedSkillForUpgrade.mpCost <= 1} className="w-full p-3 bg-gray-800 border border-gray-600 rounded flex justify-between"><span>íš¨ìœ¨ì„± ì¦ëŒ€</span><span>ğŸ’§</span></button>
                                    <button onClick={() => handleUpgradeSkill('cooldown')} disabled={selectedSkillForUpgrade.cooldown <= 0} className="w-full p-3 bg-gray-800 border border-gray-600 rounded flex justify-between"><span>ì†ë„ ê°•í™”</span><span>âš¡</span></button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>