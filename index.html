<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎÇò ÌòºÏûêÎßå Î†àÎ≤®ÏóÖ: THE SYSTEM</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        system: {
                            dark: '#0a0e17',
                            blue: '#00a8ff',
                            glow: '#0077ff',
                            text: '#e0f2fe',
                            panel: '#111827'
                        }
                    },
                    fontFamily: {
                        sans: ['Pretendard', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace'],
                    },
                    animation: {
                        'pulse-glow': 'pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'typewriter': 'typewriter 0.5s steps(40, end)',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'attack-thrust': 'attack-thrust 0.2s ease-in-out',
                        'damage-shake': 'damage-shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                        'skill-flash': 'skill-flash 0.5s ease-out',
                    },
                    keyframes: {
                        'pulse-glow': {
                            '0%, 100%': { opacity: 1, boxShadow: '0 0 10px #0077ff' },
                            '50%': { opacity: .7, boxShadow: '0 0 20px #00a8ff' },
                        },
                        'shake': {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        'attack-thrust': {
                            '0%': { transform: 'translateY(0) scale(1)' },
                            '50%': { transform: 'translateY(-20px) scale(1.05)' },
                            '100%': { transform: 'translateY(0) scale(1)' }
                        },
                        'damage-shake': {
                             '0%': { transform: 'translate(0, 0)' },
                             '25%': { transform: 'translate(5px, 5px)' },
                             '50%': { transform: 'translate(-5px, -5px)' },
                             '75%': { transform: 'translate(5px, -5px)' },
                             '100%': { transform: 'translate(0, 0)' }
                        },
                        'skill-flash': {
                            '0%': { opacity: 0, transform: 'scale(0.8)' },
                            '50%': { opacity: 1, transform: 'scale(1.2)' },
                            '100%': { opacity: 0, transform: 'scale(1.5)' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & Babel -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0"
  }
}
</script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background-color: #050505; color: white; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0a0e17; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e3a8a; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #0077ff; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useRef } from 'react';
        import ReactDOM from 'react-dom/client';

        // --- CONSTANTS & TYPES ---
        
        // Process shim
        if (typeof process === 'undefined') {
            window.process = { env: { API_KEY: '' } };
        }

        const PlayerClass = {
            NONE: "Î¨¥ÏßÅ",
            NECROMANCER: "ÎÑ§ÌÅ¨Î°úÎß®ÏÑú",
            SHADOW_MONARCH: "Í∑∏Î¶ºÏûê Íµ∞Ï£º"
        };

        const Rank = {
            E: "E", D: "D", C: "C", B: "B", A: "A", S: "S"
        };

        const STORIES = [
            { id: 0, title: "Í∞ÅÏÑ±: Ïù∏Ïä§ÌÑ¥Ïä§ ÎçòÏ†Ñ", description: "Ìï©Ï†ïÏó≠ ÏßÄÌïòÏ≤† Ïó≠. ÎÇòÎßåÏùò Î†àÎ≤®ÏóÖÏù¥ ÏãúÏûëÎêúÎã§.", requiredLevel: 1, bossName: "Ìë∏Î•∏ ÎèÖÎãà Ïπ¥ÏÇ¨Ïπ¥", bossRank: Rank.C },
            { id: 1, title: "Ï†ÑÏßÅ ÌÄòÏä§Ìä∏: Í∏∞ÏÇ¨Îã®Ïû•", description: "Í∑∏Î¶ºÏûê ÏÜçÏóê Ïà®Ïñ¥ÏûàÎäî Î∂âÏùÄ Í∏∞ÏÇ¨ÏôÄÏùò Í≤∞Ìà¨.", requiredLevel: 10, bossName: "ÌïèÎπõÏùò Ïù¥Í∑∏Î¶¨Ïä§", bossRank: Rank.A },
            { id: 2, title: "Î†àÎìú Í≤åÏù¥Ìä∏: ÏÑ§Ïõê", description: "ÏñºÏñ¥Î∂ôÏùÄ Ïà≤ ÏÜç, Î∞±Í∑ÄÎì§Í≥ºÏùò ÏÇ¨Ìà¨.", requiredLevel: 20, bossName: "Î∞±Í∑ÄÏùò Ïôï", bossRank: Rank.A },
            { id: 3, title: "ÏïÖÎßàÏùò ÏÑ±", description: "ÏßÄÏò•Ïùò Î∂àÍ∏∏ ÏÜçÏóêÏÑú ÏïÖÎßàÏôï Î∞îÎûÄÏùÑ Ï≤òÏπòÌïòÎùº.", requiredLevel: 35, bossName: "ÏïÖÎßàÏôï Î∞îÎûÄ", bossRank: Rank.S },
            { id: 4, title: "Ï†úÏ£ºÎèÑ Î†àÏù¥Îìú", description: "SÍ∏â Í≤åÏù¥Ìä∏. Í∞úÎØ∏Îì§Ïùò ÏôïÏù¥ Í∏∞Îã§Î¶∞Îã§.", requiredLevel: 50, bossName: "Í∞úÎØ∏Ïùò Ïôï Î≤†Î•¥", bossRank: Rank.S },
            { id: 5, title: "ÌûàÎì† Ï±ïÌÑ∞: Ïù¥Ï§ë ÎçòÏ†Ñ", description: "ÏãúÏûëÏù¥ ÏûàÏóàÎçò Í≥≥ÏúºÎ°ú ÎèåÏïÑÍ∞ëÎãàÎã§.", requiredLevel: 70, bossName: "ÏãúÏä§ÌÖú Í¥ÄÎ¶¨Ïûê (Í∞úÎ∞úÏûê)", bossRank: Rank.S }
        ];

        // --- COMPONENTS ---

        // GameLog Component
        const GameLog = ({ logs }) => {
            const bottomRef = useRef(null);

            useEffect(() => {
                bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [logs]);

            return (
                <div className="flex-1 bg-system-panel/50 border border-system-blue/30 p-4 overflow-y-auto min-h-[200px] max-h-[300px] lg:max-h-[400px] rounded-lg backdrop-blur-sm custom-scrollbar">
                    <div className="flex flex-col space-y-2">
                        {logs.length === 0 && (
                            <div className="text-gray-500 text-sm italic text-center my-10">
                                ÏãúÏä§ÌÖú Î©îÏãúÏßÄÎ•º Í∏∞Îã§Î¶¨Îäî Ï§ë...
                            </div>
                        )}
                        {logs.map((log) => (
                            <div key={log.id} className={`text-sm font-mono animate-typewriter overflow-hidden whitespace-normal break-words
                                ${log.type === 'system' ? 'text-system-blue font-bold' : ''}
                                ${log.type === 'danger' ? 'text-red-500 font-bold' : ''}
                                ${log.type === 'gain' ? 'text-green-400' : ''}
                                ${log.type === 'combat' ? 'text-gray-300' : ''}
                                ${log.type === 'info' ? 'text-gray-400' : ''}
                                ${log.type === 'story' ? 'text-yellow-400 font-bold' : ''}
                            `}>
                                <span className="opacity-50 text-xs mr-2">[{new Date(log.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}]</span>
                                {log.type === 'system' && '„ÄêSYSTEM„Äë '}
                                {log.text}
                            </div>
                        ))}
                        <div ref={bottomRef} />
                    </div>
                </div>
            );
        };

        // StatusWindow Component
        const StatusWindow = ({ player, onIncreaseStat, onOpenUpgradeModal, onToggleEquip, onOpenCodeModal }) => {
            
            const getEquippedBonus = (type) => {
                return player.inventory
                    .filter(i => i.isEquipped && i.type === type)
                    .reduce((acc, curr) => acc + curr.effectValue, 0);
            };

            const attackBonus = getEquippedBonus('WEAPON');
            const defenseBonus = getEquippedBonus('ARMOR');

            return (
                <div className="w-full lg:w-1/3 bg-black/80 border border-system-blue shadow-[0_0_15px_rgba(0,168,255,0.2)] p-4 rounded-lg text-system-text font-sans relative overflow-hidden group flex flex-col gap-6 h-fit">
                    <div className="absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] z-0 pointer-events-none bg-[length:100%_2px,3px_100%]"></div>
                    
                    <div className="relative z-10">
                        <div className="flex justify-between items-center mb-4 border-b border-system-blue/50 pb-2">
                            <h2 className="text-2xl font-bold text-system-blue tracking-widest">STATUS</h2>
                            {onOpenCodeModal && (
                                <button 
                                    onClick={onOpenCodeModal} 
                                    className="text-[10px] bg-system-blue/20 hover:bg-system-blue text-system-blue hover:text-black border border-system-blue px-3 py-1 rounded transition-all font-bold tracking-wider hover:shadow-[0_0_10px_#00a8ff]"
                                >
                                    ADMIN CODE
                                </button>
                            )}
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <p className="text-xs text-gray-400">NAME</p>
                                <div className="flex items-center gap-2">
                                    <p className="text-lg font-bold">{player.name}</p>
                                </div>
                            </div>
                            <div>
                                <p className="text-xs text-gray-400">LEVEL</p>
                                <p className="text-lg font-bold text-yellow-400">{player.level}</p>
                            </div>
                            <div>
                                <p className="text-xs text-gray-400">JOB</p>
                                <p className="text-sm">{player.job}</p>
                            </div>
                            <div>
                                <p className="text-xs text-gray-400">TITLE</p>
                                <p className="text-sm">{player.title}</p>
                            </div>
                        </div>

                        <div className="mb-6 space-y-3">
                            <div>
                                <div className="flex justify-between text-xs mb-1">
                                    <span className="text-red-400 font-bold">HP</span>
                                    <span>{player.hp} / {player.maxHp}</span>
                                </div>
                                <div className="h-2 bg-gray-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-red-600 transition-all duration-300" style={{ width: `${Math.max(0, (player.hp / player.maxHp) * 100)}%` }} />
                                </div>
                            </div>
                            <div>
                                <div className="flex justify-between text-xs mb-1">
                                    <span className="text-blue-400 font-bold">MP</span>
                                    <span>{player.mp} / {player.maxMp}</span>
                                </div>
                                <div className="h-2 bg-gray-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-blue-600 transition-all duration-300" style={{ width: `${Math.max(0, (player.mp / player.maxMp) * 100)}%` }} />
                                </div>
                            </div>
                            <div>
                                <div className="flex justify-between text-xs mb-1">
                                    <span className="text-yellow-400 font-bold">EXP</span>
                                    <span>{player.currentExp} / {player.maxExp}</span>
                                </div>
                                <div className="h-1 bg-gray-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-yellow-500 transition-all duration-300" style={{ width: `${(player.currentExp / player.maxExp) * 100}%` }} />
                                </div>
                            </div>
                        </div>

                        <div className="space-y-2">
                            <div className="flex justify-between items-center border-b border-gray-800 pb-1">
                                <span className="text-sm text-gray-400">Îä•Î†•Ïπò Ìè¨Ïù∏Ìä∏</span>
                                <span className={`font-mono font-bold ${player.statPoints > 0 ? 'text-yellow-400 animate-pulse' : 'text-gray-600'}`}>
                                    {player.statPoints}
                                </span>
                            </div>

                            {['strength', 'agility', 'sense', 'vitality', 'intelligence'].map((stat) => (
                                <div key={stat} className="flex items-center justify-between h-8">
                                    <span className="text-sm uppercase w-24 text-gray-300">
                                        {stat === 'strength' && 'Í∑ºÎ†• (STR)'}
                                        {stat === 'agility' && 'ÎØºÏ≤© (AGI)'}
                                        {stat === 'sense' && 'Í∞êÍ∞Å (SNS)'}
                                        {stat === 'vitality' && 'Ï≤¥Î†• (VIT)'}
                                        {stat === 'intelligence' && 'ÏßÄÎä• (INT)'}
                                    </span>
                                    <div className="flex gap-2">
                                        <span className="font-mono text-system-blue font-bold">{player.stats[stat]}</span>
                                        {stat === 'strength' && attackBonus > 0 && <span className="text-xs text-green-400 flex items-center">(+{attackBonus})</span>}
                                        {stat === 'vitality' && defenseBonus > 0 && <span className="text-xs text-green-400 flex items-center">(+{defenseBonus})</span>}
                                    </div>
                                    {player.statPoints > 0 && (
                                        <button 
                                            onClick={() => onIncreaseStat(stat)}
                                            className="ml-2 w-6 h-6 rounded bg-system-blue/20 text-system-blue hover:bg-system-blue hover:text-black text-xs flex items-center justify-center transition-colors"
                                        >
                                            +
                                        </button>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="relative z-10 border-t border-gray-800 pt-4">
                        <h3 className="text-sm font-bold text-gray-400 mb-3">Ïû•ÎπÑ / Ïù∏Î≤§ÌÜ†Î¶¨</h3>
                        <div className="grid grid-cols-4 gap-2">
                            {player.inventory.map((item, idx) => (
                                <button 
                                    key={idx}
                                    onClick={() => onToggleEquip(item)}
                                    className={`relative aspect-square border rounded p-1 flex items-center justify-center group overflow-hidden
                                        ${item.isEquipped ? 'border-system-blue bg-system-blue/20 shadow-[0_0_10px_rgba(0,168,255,0.3)]' : 'border-gray-700 bg-gray-900/50 hover:border-gray-500'}
                                    `}
                                    title={item.name + (item.count ? ` x${item.count}` : '')}
                                >
                                    <span className="text-xl">
                                        {item.type === 'WEAPON' ? '‚öîÔ∏è' : item.type === 'ARMOR' ? 'üõ°Ô∏è' : item.id === 'gacha_ticket' ? 'üé´' : 'üíä'}
                                    </span>
                                    {item.count && item.count > 1 && (
                                        <span className="absolute bottom-0 right-0 bg-black/80 text-[10px] px-1 rounded-tl">{item.count}</span>
                                    )}
                                    {item.isEquipped && (
                                        <div className="absolute top-0 right-0 w-2 h-2 bg-system-blue rounded-full shadow-[0_0_5px_#00a8ff]"></div>
                                    )}
                                </button>
                            ))}
                            {Array.from({ length: Math.max(0, 8 - player.inventory.length) }).map((_, i) => (
                                <div key={`empty-${i}`} className="aspect-square border border-gray-800 bg-black/30 rounded"></div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ActionPanel Data & Logic ---
        
        const ENEMIES_BY_RANK = {
            [Rank.E]: [
                { name: "Í≥†Î∏îÎ¶∞", rank: Rank.E, hp: 50, maxHp: 50, attack: 8, description: "ÏûëÍ≥† ÍµêÌôúÌïú Î™¨Ïä§ÌÑ∞ÏûÖÎãàÎã§.", isBoss: false },
                { name: "Ïä¨ÎùºÏûÑ", rank: Rank.E, hp: 60, maxHp: 60, attack: 5, description: "Ï†êÏï°ÏßàÏùò Î™¨Ïä§ÌÑ∞ÏûÖÎãàÎã§.", isBoss: false },
                { name: "Í∞ïÏ≤† Ïù¥Îπ® ÎäëÎåÄ", rank: Rank.E, hp: 80, maxHp: 80, attack: 12, description: "ÎÇ†Ïπ¥Î°úÏö¥ Ïù¥Îπ®ÏùÑ Í∞ÄÏ°åÏäµÎãàÎã§.", isBoss: false }
            ],
            [Rank.D]: [
                { name: "Ìôâ Í≥†Î∏îÎ¶∞", rank: Rank.D, hp: 150, maxHp: 150, attack: 25, description: "ÏùºÎ∞ò Í≥†Î∏îÎ¶∞Î≥¥Îã§ Îç©ÏπòÍ∞Ä ÌÅΩÎãàÎã§.", isBoss: false },
                { name: "Ïä§ÌÜ§ Í≥®Î†ò", rank: Rank.D, hp: 300, maxHp: 300, attack: 15, description: "ÎèåÎ°ú Ïù¥Î£®Ïñ¥ÏßÑ Îã®Îã®Ìïú Î™¨Ïä§ÌÑ∞ÏûÖÎãàÎã§.", isBoss: false }
            ],
            [Rank.C]: [
                { name: "Î¶¨ÏûêÎìúÎß®", rank: Rank.C, hp: 400, maxHp: 400, attack: 45, description: "ÎπÑÎäòÎ°ú ÎçÆÏù∏ Ïù∏Í∞ÑÌòï Î™¨Ïä§ÌÑ∞ÏûÖÎãàÎã§.", isBoss: false },
                { name: "ÏûêÏù¥Ïñ∏Ìä∏ Ïä§ÌååÏù¥Îçî", rank: Rank.C, hp: 350, maxHp: 350, attack: 50, description: "Í±∞ÎåÄÌïú ÎèÖÍ±∞ÎØ∏ÏûÖÎãàÎã§.", isBoss: false },
                { name: "Í≥†Î∏îÎ¶∞ ÎßàÎ≤ïÏÇ¨", rank: Rank.C, hp: 250, maxHp: 250, attack: 70, description: "ÌôîÏóºÍµ¨Î•º ÎçòÏßÄÎäî Í≥†Î∏îÎ¶∞ÏûÖÎãàÎã§.", isBoss: false },
                { name: "Îã§ÌÅ¨ ÏóòÌîÑ Í∂ÅÏàò", rank: Rank.C, hp: 300, maxHp: 300, attack: 65, description: "Ï†ïÌôïÌïú ÏÇ¨Í≤©ÏùÑ Í∞ÄÌïòÎäî ÏóòÌîÑÏûÖÎãàÎã§.", isBoss: false }
            ],
            [Rank.B]: [
                { name: "ÏïÑÏù¥Ïñ∏ Í≥®Î†ò", rank: Rank.B, hp: 1000, maxHp: 1000, attack: 70, description: "Í∞ïÏ≤†Î°ú ÎßåÎì§Ïñ¥ÏßÑ Í≥®Î†òÏûÖÎãàÎã§.", isBoss: false },
                { name: "ÏÑ§Ïù∏", rank: Rank.B, hp: 900, maxHp: 900, attack: 80, description: "ÌòπÌïúÏùò Ï∂îÏúÑÎ•º Í≤¨ÎîîÎäî Î™¨Ïä§ÌÑ∞ÏûÖÎãàÎã§.", isBoss: false },
                { name: "ÌôîÏóº ÎèÑÎßàÎ±Ä", rank: Rank.B, hp: 800, maxHp: 800, attack: 90, description: "Î™∏ÏóêÏÑú Î∂àÍ∏∏Ïù¥ ÏÜüÏïÑÏò§Î¶ÖÎãàÎã§.", isBoss: false },
                { name: "Ïò§ÌÅ¨ Ï£ºÏà†ÏÇ¨", rank: Rank.B, hp: 600, maxHp: 600, attack: 120, description: "Ï†ÄÏ£ºÎ•º Í±∞Îäî Ïò§ÌÅ¨ÏûÖÎãàÎã§.", isBoss: false },
                { name: "ÌÉÄÎùΩÌïú ÏÇ¨Ï†ú", rank: Rank.B, hp: 700, maxHp: 700, attack: 60, description: "Ïñ¥Îë†Ïùò ÌûòÏúºÎ°ú ÌöåÎ≥µÌï©ÎãàÎã§.", isBoss: false }
            ],
            [Rank.A]: [
                { name: "ÌïòÏù¥ Ïò§ÌÅ¨ Ï†ÑÏÇ¨", rank: Rank.A, hp: 2000, maxHp: 2000, attack: 120, description: "Î∂âÏùÄ ÌîºÎ∂ÄÏùò Í≥†ÏúÑ Ïò§ÌÅ¨ÏûÖÎãàÎã§.", isBoss: false },
                { name: "ÏÑ§ÏõêÏùò Î∞±Í∑Ä", rank: Rank.A, hp: 1800, maxHp: 1800, attack: 130, description: "ÎààÎ≥¥Îùº ÏÜçÏóê Ïà®ÏùÄ Í∑ÄÏã†ÏûÖÎãàÎã§.", isBoss: false },
                { name: "ÎßàÍ∑∏Îßà Í±∞Ïù∏", rank: Rank.A, hp: 2500, maxHp: 2500, attack: 110, description: "Ïö©ÏïîÏóêÏÑú ÌÉúÏñ¥ÎÇú Í±∞Ïù∏ÏûÖÎãàÎã§.", isBoss: false },
                { name: "ÏïîÏÇ¥Ïûê ÎÇòÏù¥Ìä∏", rank: Rank.A, hp: 1500, maxHp: 1500, attack: 180, description: "Í∑∏Î¶ºÏûê ÏÜçÏóê Ïà®Ïñ¥ Í≥µÍ≤©Ìï©ÎãàÎã§.", isBoss: false }
            ],
            [Rank.S]: [
                { name: "ÎìúÎûòÍ≥§", rank: Rank.S, hp: 10000, maxHp: 10000, attack: 500, description: "ÏµúÏÉÅÏúÑ Ìè¨ÏãùÏûêÏûÖÎãàÎã§.", isBoss: true },
                { name: "Í±∞Ïù∏Ïôï", rank: Rank.S, hp: 12000, maxHp: 12000, attack: 450, description: "Î™®Îì† Í≤ÉÏùÑ ÏßìÎ∞üÎäî ÏôïÏûÖÎãàÎã§.", isBoss: true }
            ]
        };

        const generateDungeonScenarioLocal = (rank, theme) => {
            const base = `${rank}Í∏â Í≤åÏù¥Ìä∏Ïóê ÏûÖÏû•ÌñàÏäµÎãàÎã§.`;
            const themeDesc = theme ? `${theme}Ïùò Ï∞®Í∞ÄÏö¥ Í≥µÍ∏∞Í∞Ä ÌîºÎ∂ÄÎ•º Ïä§Ïπ©ÎãàÎã§.` : "Ïñ¥Îë†Ïù¥ ÏßôÍ≤å ÍπîÎ†§ ÏûàÏäµÎãàÎã§.";
            const danger = "Ïñ¥ÎîîÏÑ†Í∞Ä Î™¨Ïä§ÌÑ∞Ïùò Í∏∞Ï≤ôÏù¥ ÎäêÍª¥ÏßëÎãàÎã§.";
            return `${base} ${themeDesc} ${danger}`;
        };

        const generateEnemyLocal = (rank, specificName) => {
            if (specificName === "ÏãúÏä§ÌÖú Í¥ÄÎ¶¨Ïûê (Í∞úÎ∞úÏûê)") {
                return { name: "ÏãúÏä§ÌÖú Í¥ÄÎ¶¨Ïûê (Í∞úÎ∞úÏûê)", rank: Rank.S, hp: 50000, maxHp: 50000, attack: 2000, description: "Ïù¥ ÏÑ∏Í≥ÑÏùò Ï∞ΩÏ°∞Ï£ºÏûÖÎãàÎã§.", isBoss: true };
            }
            if (specificName) {
                let hp = 100, atk = 10;
                if (rank === Rank.C) { hp = 800; atk = 60; }
                if (rank === Rank.A) { hp = 4000; atk = 200; }
                if (rank === Rank.S) { hp = 20000; atk = 1000; }
                return { name: specificName, rank, hp, maxHp: hp, attack: atk, description: "ÎçòÏ†ÑÏùò Ï£ºÏù∏ÏûÖÎãàÎã§.", isBoss: true };
            }
            const candidates = ENEMIES_BY_RANK[rank] || ENEMIES_BY_RANK[Rank.E];
            const template = candidates[Math.floor(Math.random() * candidates.length)];
            const variance = 0.9 + Math.random() * 0.2;
            const finalHp = Math.floor(template.maxHp * variance);
            const finalAtk = Math.floor(template.attack * variance);
            return { ...template, hp: finalHp, maxHp: finalHp, attack: finalAtk };
        };

        const SHOP_ITEMS_RAW = [
            { id: 'hp_potion_s', name: 'ÏÜåÌòï HP Ìè¨ÏÖò', type: 'CONSUMABLE', description: 'Ï≤¥Î†•ÏùÑ 50 ÌöåÎ≥µÌï©ÎãàÎã§.', price: 100, effectValue: 50, count: 1 },
            { id: 'hp_potion_m', name: 'Ï§ëÌòï HP Ìè¨ÏÖò', type: 'CONSUMABLE', description: 'Ï≤¥Î†•ÏùÑ 200 ÌöåÎ≥µÌï©ÎãàÎã§.', price: 300, effectValue: 200, count: 1 },
            { id: 'hp_potion_l', name: 'ÎåÄÌòï HP Ìè¨ÏÖò', type: 'CONSUMABLE', description: 'Ï≤¥Î†•ÏùÑ 500 ÌöåÎ≥µÌï©ÎãàÎã§.', price: 800, effectValue: 500, count: 1 },
            { id: 'hp_potion_x', name: 'Ï¥àÎåÄÌòï HP Ìè¨ÏÖò', type: 'CONSUMABLE', description: 'Ï≤¥Î†•ÏùÑ 1000 ÌöåÎ≥µÌï©ÎãàÎã§.', price: 2000, effectValue: 1000, count: 1 },
            { id: 'mp_potion_s', name: 'ÏÜåÌòï MP Ìè¨ÏÖò', type: 'CONSUMABLE', description: 'ÎßàÎ†•ÏùÑ 30 ÌöåÎ≥µÌï©ÎãàÎã§.', price: 100, effectValue: 30, count: 1 },
            { id: 'mp_potion_m', name: 'Ï§ëÌòï MP Ìè¨ÏÖò', type: 'CONSUMABLE', description: 'ÎßàÎ†•ÏùÑ 100 ÌöåÎ≥µÌï©ÎãàÎã§.', price: 300, effectValue: 100, count: 1 },
            { id: 'mp_potion_l', name: 'ÎåÄÌòï MP Ìè¨ÏÖò', type: 'CONSUMABLE', description: 'ÎßàÎ†•ÏùÑ 300 ÌöåÎ≥µÌï©ÎãàÎã§.', price: 800, effectValue: 300, count: 1 },
            { id: 'elixir', name: 'ÏóòÎ¶≠ÏÑú', type: 'CONSUMABLE', description: 'Ï≤¥Î†•Í≥º ÎßàÎ†•ÏùÑ ÏôÑÏ†ÑÌûà ÌöåÎ≥µÌï©ÎãàÎã§.', price: 5000, effectValue: 9999, count: 1 },
            { id: 'gacha_ticket', name: 'Î¨¥Î£å ÎΩëÍ∏∞Í∂å', type: 'CONSUMABLE', description: 'ÎûúÎç§ Î∞ïÏä§Î•º 1Ìöå Î¨¥Î£åÎ°ú ÏóΩÎãàÎã§.', price: 1000, effectValue: 0, count: 1 },
            { id: 'iron_sword', name: 'Í∞ïÏ≤† Í≤Ä', type: 'WEAPON', slot: 'WEAPON', description: 'Í∏∞Î≥∏Ï†ÅÏù∏ Í≤Ä. (Í≥µÍ≤©Î†• +5)', price: 1000, effectValue: 5 },
            { id: 'knight_dagger', name: 'Í∏∞ÏÇ¨Ïùò Îã®Í≤Ä', type: 'WEAPON', slot: 'WEAPON', description: 'ÏòàÎ¶¨Ìïú Îã®Í≤Ä. (Í≥µÍ≤©Î†• +10)', price: 5000, effectValue: 10 },
            { id: 'steel_dagger', name: 'Ï†ïÎ∞ÄÌïú Í∞ïÏ≤† Îã®Í≤Ä', type: 'WEAPON', slot: 'WEAPON', description: 'ÏàôÎ†®ÏûêÎ•º ÏúÑÌïú Îã®Í≤Ä. (Í≥µÍ≤©Î†• +15)', price: 8000, effectValue: 15 },
            { id: 'orc_axe', name: 'Ïò§ÌÅ¨ ÎåÄÏû•Íµ∞Ïùò ÎèÑÎÅº', type: 'WEAPON', slot: 'WEAPON', description: 'ÌååÍ¥¥Î†•Ïù¥ Îõ∞Ïñ¥ÎÇ©ÎãàÎã§. (Í≥µÍ≤©Î†• +25)', price: 15000, effectValue: 25 },
            { id: 'knight_killer', name: 'ÎÇòÏù¥Ìä∏ ÌÇ¨Îü¨', type: 'WEAPON', slot: 'WEAPON', description: 'Í∞ëÏò∑ÏùÑ Îö´Îäî Îã®Í≤Ä. (Í≥µÍ≤©Î†• +35)', price: 30000, effectValue: 35 },
            { id: 'magic_sword', name: 'ÎßàÎ†• ÍπÉÎì† Ïû•Í≤Ä', type: 'WEAPON', slot: 'WEAPON', description: 'ÎßàÎ†•Ïù¥ ÌùêÎ•¥Îäî Í≤Ä. (Í≥µÍ≤©Î†• +50)', price: 60000, effectValue: 50 },
            { id: 'baruka_dagger', name: 'Î∞îÎ£®Ïπ¥Ïùò Îã®Í≤Ä', type: 'WEAPON', slot: 'WEAPON', description: 'ÎØºÏ≤©Ìï®ÏùÑ Í∑πÎåÄÌôîÌï©ÎãàÎã§. (Í≥µÍ≤©Î†• +75)', price: 120000, effectValue: 75 },
            { id: 'demon_longsword', name: 'ÏïÖÎßàÏôïÏùò Ïû•Í≤Ä', type: 'WEAPON', slot: 'WEAPON', description: 'Ï†ÑÏú®Ïù¥ ÎäêÍª¥ÏßÄÎäî Í≤Ä. (Í≥µÍ≤©Î†• +120)', price: 250000, effectValue: 120 },
            { id: 'kamish_wrath', name: 'Ïπ¥ÎØ∏Ïâ¨Ïùò Î∂ÑÎÖ∏', type: 'WEAPON', slot: 'WEAPON', description: 'Ïö©Ïùò ÎºàÎ°ú ÎßåÎì† ÏµúÍ∞ïÏùò Îã®Í≤Ä. (Í≥µÍ≤©Î†• +300)', price: 1000000, effectValue: 300 },
            { id: 'leather_armor', name: 'Í∞ÄÏ£Ω Í∞ëÏò∑', type: 'ARMOR', slot: 'BODY', description: 'ÌôúÎèôÌïòÍ∏∞ Ìé∏Ìïú Í∞ëÏò∑. (Î∞©Ïñ¥Î†• +5)', price: 1500, effectValue: 5 },
            { id: 'hard_leather', name: 'Í≤ΩÌôî Í∞ÄÏ£Ω Í∞ëÏò∑', type: 'ARMOR', slot: 'BODY', description: 'Îã®Îã®ÌïòÍ≤å Í∞ÄÍ≥µÎêú Í∞ÄÏ£Ω. (Î∞©Ïñ¥Î†• +10)', price: 3000, effectValue: 10 },
            { id: 'chainmail', name: 'ÏÇ¨Ïä¨ Í∞ëÏò∑', type: 'ARMOR', slot: 'BODY', description: 'Î≤†Í∏∞ Í≥µÍ≤©ÏùÑ ÎßâÏïÑÏ§çÎãàÎã§. (Î∞©Ïñ¥Î†• +18)', price: 7500, effectValue: 18 },
            { id: 'plate_armor', name: 'ÌåêÍ∏à Í∞ëÏò∑', type: 'ARMOR', slot: 'BODY', description: 'Îã®Îã®Ìïú Í∞ïÏ≤† Í∞ëÏò∑. (Î∞©Ïñ¥Î†• +30)', price: 25000, effectValue: 30 },
            { id: 'knight_heavy', name: 'Í∏∞ÏÇ¨Îã®Ïû•Ïùò Ï§ëÍ∞ë', type: 'ARMOR', slot: 'BODY', description: 'Í∏∞ÏÇ¨Îã®Ïû•Ïù¥ ÏûÖÎçò Í∞ëÏò∑. (Î∞©Ïñ¥Î†• +45)', price: 50000, effectValue: 45 },
            { id: 'commander_coat', name: 'ÏÇ¨Î†πÍ¥ÄÏùò ÏΩîÌä∏', type: 'ARMOR', slot: 'BODY', description: 'ÎßàÎ≤ï Ï†ÄÌï≠Î†•Ïù¥ ÏûàÏäµÎãàÎã§. (Î∞©Ïñ¥Î†• +60)', price: 100000, effectValue: 60 },
            { id: 'dragon_scale', name: 'Ïö©ÎπÑÎäò Í∞ëÏò∑', type: 'ARMOR', slot: 'BODY', description: 'Îö´ÏùÑ Ïàò ÏóÜÎäî Ï†àÎåÄ Î∞©Ïñ¥. (Î∞©Ïñ¥Î†• +150)', price: 500000, effectValue: 150 },
            { id: 'high_orc_helm', name: 'ÌïòÏù¥Ïò§ÌÅ¨Ïùò Ìà¨Íµ¨', type: 'ARMOR', slot: 'HEAD', description: 'ÏúÑÏïïÏ†ÅÏù∏ Ìà¨Íµ¨. (Î∞©Ïñ¥Î†• +20)', price: 35000, effectValue: 20 },
            { id: 'ring_str', name: 'ÌûòÏùò Î∞òÏßÄ', type: 'WEAPON', slot: 'ACCESSORY', description: 'Ï∞©Ïö© Ïãú ÌûòÏù¥ ÏÜüÏäµÎãàÎã§. (Í≥µÍ≤©Î†• +10)', price: 20000, effectValue: 10 },
            { id: 'neck_def', name: 'ÏàòÌò∏Ïùò Î™©Í±∏Ïù¥', type: 'ARMOR', slot: 'ACCESSORY', description: 'Ï∞©Ïö© Ïãú Î≥¥Ìò∏Îßâ ÏÉùÏÑ±. (Î∞©Ïñ¥Î†• +15)', price: 20000, effectValue: 15 },
        ];
        
        const SHOP_ITEMS = SHOP_ITEMS_RAW.filter(i => i.id !== 'gacha_ticket').sort((a, b) => a.price - b.price);

        // ActionPanel Component
        const ActionPanel = ({ player, addLog, updatePlayer, onEnemyDefeated, onPlayerDamage }) => {
            const [gameState, setGameState] = useState('IDLE');
            const [activeTab, setActiveTab] = useState('STORY');
            const [currentEnemy, setCurrentEnemy] = useState(null);
            const [lastDefeatedEnemy, setLastDefeatedEnemy] = useState(null);
            const [loading, setLoading] = useState(false);
            const [activeStoryId, setActiveStoryId] = useState(null);
            const [extractionAttempted, setExtractionAttempted] = useState(false);
            const [combatAnim, setCombatAnim] = useState('IDLE');
            
            // Dungeon Progress State
            const [dungeonProgress, setDungeonProgress] = useState({ active: false, current: 0, total: 0, rank: null, theme: '' });
            
            // Shop State
            const [shopMode, setShopMode] = useState('BUY'); // 'BUY' or 'SELL'

            const calculatePlayerDamage = (multiplier = 1) => {
                const companionBonus = player.companions.reduce((acc, curr) => acc + curr.attackBonus, 0);
                const equipmentBonus = player.inventory.filter(i => i.isEquipped && i.type === 'WEAPON').reduce((acc, curr) => acc + curr.effectValue, 0);
                const baseDmg = (player.stats.strength * 2) + (player.stats.agility) + companionBonus + equipmentBonus;
                const variance = Math.random() * 0.4 + 0.8;
                const critChance = player.stats.sense * 0.01;
                const isCrit = Math.random() < critChance;
                let damage = Math.floor(baseDmg * variance * multiplier);
                if (isCrit) damage = Math.floor(damage * 1.5);
                return { damage, isCrit };
            };

            const handleEnterDungeon = async (rank, theme) => {
                if (loading) return;
                setLoading(true);
                addLog(`${rank}Í∏â Í≤åÏù¥Ìä∏Ïóê ÏûÖÏû•Ìï©ÎãàÎã§... (Ï¥ù 5Í∞ú Íµ¨Ïó≠)`, 'info');
                setDungeonProgress({ active: true, current: 1, total: 5, rank: rank, theme: theme });
                const scenario = generateDungeonScenarioLocal(rank, theme);
                addLog(scenario, 'system');
                setTimeout(async () => {
                    const enemy = generateEnemyLocal(rank);
                    setCurrentEnemy(enemy);
                    setGameState('COMBAT');
                    setActiveStoryId(null);
                    setExtractionAttempted(false);
                    addLog(`[WAVE 1/5] ${enemy.name}(Ïù¥)Í∞Ä ÎÇòÌÉÄÎÇ¨ÏäµÎãàÎã§!`, 'danger');
                    setLoading(false);
                }, 1500);
            };

            const handleNextDungeonWave = () => {
                const nextWave = dungeonProgress.current + 1;
                setLoading(true);
                setDungeonProgress(prev => ({ ...prev, current: nextWave }));
                setGameState('EXPLORING'); 
                setTimeout(() => {
                    const enemy = generateEnemyLocal(dungeonProgress.rank);
                    if (nextWave === 5) enemy.isBoss = true; 
                    setCurrentEnemy(enemy);
                    setGameState('COMBAT');
                    setLastDefeatedEnemy(null);
                    setExtractionAttempted(false);
                    setLoading(false);
                    addLog(`[WAVE ${nextWave}/5] Îçî ÍπäÏùÄ Í≥≥ÏóêÏÑú ${enemy.name}(Ïù¥)Í∞Ä ÎÇòÌÉÄÎÇ¨ÏäµÎãàÎã§!`, 'danger');
                }, 1000);
            };

            const handleStartStory = async (storyId) => {
                const story = STORIES[storyId];
                if (player.level < story.requiredLevel) {
                    addLog(`Î†àÎ≤®Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. (ÌïÑÏöî Î†àÎ≤®: ${story.requiredLevel})`, 'danger');
                    return;
                }
                setLoading(true);
                setActiveStoryId(storyId);
                setExtractionAttempted(false);
                setDungeonProgress({ active: false, current: 0, total: 0, rank: null, theme: '' });
                addLog(`[Î©îÏù∏ Ïä§ÌÜ†Î¶¨] ${story.title} ÏãúÏûë...`, 'story');
                addLog(`Ï†ÑÏÑ§Ï†ÅÏù∏ Î™¨Ïä§ÌÑ∞, ${story.bossName}Í∞Ä ÎÇòÌÉÄÎÇ¨ÏäµÎãàÎã§!`, 'system');
                setTimeout(async () => {
                    const boss = generateEnemyLocal(story.bossRank, story.bossName);
                    boss.isBoss = true;
                    setCurrentEnemy(boss);
                    setGameState('COMBAT');
                    setLoading(false);
                }, 2000);
            };

            const handleAttack = () => {
                if (!currentEnemy) return;
                setCombatAnim('ATTACK');
                setTimeout(() => setCombatAnim('IDLE'), 200);
                const { damage, isCrit } = calculatePlayerDamage(1);
                if (isCrit) addLog(`[ÏπòÎ™ÖÌÉÄ!] Í∏âÏÜåÎ•º Ï†ïÌôïÌûà Í∞ÄÍ≤©ÌñàÏäµÎãàÎã§!`, 'danger');
                
                const newEnemyHp = currentEnemy.hp - damage;
                setCurrentEnemy({ ...currentEnemy, hp: newEnemyHp });
                
                if (player.companions.length > 0 && Math.random() > 0.7) {
                    const comp = player.companions[Math.floor(Math.random() * player.companions.length)];
                    addLog(`${comp.name}(Ïù¥)Í∞Ä Ìï®Íªò Í≥µÍ≤©Ìï©ÎãàÎã§!`, 'info');
                }
                addLog(`${currentEnemy.name}ÏóêÍ≤å ${damage}Ïùò ÌîºÌï¥Î•º ÏûÖÌòîÏäµÎãàÎã§.`, 'combat');

                if (newEnemyHp <= 0) handleVictory();
                else setTimeout(handleEnemyTurn, 800);
            };

            const handleSkillUse = (skill) => {
                if (!currentEnemy) return;
                if (player.mp < skill.mpCost) {
                    addLog("ÎßàÎ†•Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§!", 'danger');
                    return;
                }
                setCombatAnim('SKILL');
                setTimeout(() => setCombatAnim('IDLE'), 500);
                updatePlayer({ mp: player.mp - skill.mpCost });

                if (skill.effect === 'heal') {
                    const healAmount = Math.floor(player.maxHp * 0.4);
                    updatePlayer({ hp: Math.min(player.maxHp, player.hp + healAmount) });
                    addLog(`[Ïä§ÌÇ¨] ${skill.name} ÏÇ¨Ïö©! Ï≤¥Î†•Ïù¥ ${healAmount} ÌöåÎ≥µÎêòÏóàÏäµÎãàÎã§.`, 'gain');
                    setTimeout(handleEnemyTurn, 800);
                    return;
                }

                if (skill.damageMult) {
                    const { damage } = calculatePlayerDamage(skill.damageMult);
                    const newEnemyHp = currentEnemy.hp - damage;
                    setCurrentEnemy({ ...currentEnemy, hp: newEnemyHp });
                    addLog(`[Ïä§ÌÇ¨] ${skill.name}! ${damage}Ïùò ÎßâÎåÄÌïú ÌîºÌï¥!`, 'danger');
                    if (newEnemyHp <= 0) handleVictory();
                    else setTimeout(handleEnemyTurn, 800);
                    return;
                }
                addLog(`[Ïä§ÌÇ¨] ${skill.name} Î∞úÎèô!`, 'info');
                setTimeout(handleEnemyTurn, 800);
            };

            const handleEnemyTurn = () => {
                if (!currentEnemy || gameState !== 'COMBAT') return;
                const armorBonus = player.inventory.filter(i => i.isEquipped && i.type === 'ARMOR').reduce((acc, curr) => acc + curr.effectValue, 0);
                const defense = (player.stats.vitality * 0.8) + armorBonus;
                const dodgeChance = Math.min(0.5, player.stats.agility * 0.005); 
                
                if (Math.random() < dodgeChance) {
                    addLog(`Îπ†Î•∏ Î™∏ÎÜÄÎ¶ºÏúºÎ°ú ${currentEnemy.name}Ïùò Í≥µÍ≤©ÏùÑ ÌöåÌîºÌñàÏäµÎãàÎã§!`, 'gain');
                    return;
                }

                setCombatAnim('HIT');
                setTimeout(() => setCombatAnim('IDLE'), 500);
                const rawDmg = currentEnemy.attack;
                const finalDmg = Math.max(1, Math.floor(rawDmg - defense));
                addLog(`${currentEnemy.name}Ïùò Í≥µÍ≤©! ${finalDmg}Ïùò ÌîºÌï¥Î•º ÏûÖÏóàÏäµÎãàÎã§. ${armorBonus > 0 ? `(Î∞©Ïñ¥Íµ¨ Ìö®Í≥º -${armorBonus})` : ''}`, 'danger');
                onPlayerDamage(finalDmg);
            };

            const handleVictory = () => {
                if (!currentEnemy) return;
                addLog(`${currentEnemy.name}ÏùÑ(Î•º) Ï≤òÏπòÌñàÏäµÎãàÎã§!`, 'gain');
                let expBase = 0, goldBase = 0;
                switch(currentEnemy.rank) {
                    case Rank.E: expBase = 20; goldBase = 100; break;
                    case Rank.D: expBase = 50; goldBase = 300; break;
                    case Rank.C: expBase = 150; goldBase = 1000; break;
                    case Rank.B: expBase = 500; goldBase = 5000; break;
                    case Rank.A: expBase = 2000; goldBase = 20000; break;
                    case Rank.S: expBase = 10000; goldBase = 100000; break;
                }
                if (currentEnemy.isBoss) {
                    expBase *= 3; goldBase *= 5;
                    addLog("Î≥¥Ïä§ Ï≤òÏπò Î≥¥ÎÑàÏä§ ÌöçÎìù!", 'gain');
                }
                onEnemyDefeated(currentEnemy.rank, expBase, goldBase, activeStoryId !== null ? activeStoryId : undefined);
                setLastDefeatedEnemy(currentEnemy);
                setCurrentEnemy(null);
                setGameState('VICTORY');
            };

            const handleExtraction = () => {
                if (!lastDefeatedEnemy) return;
                if (extractionAttempted) { addLog("Ïù¥ÎØ∏ Ï∂îÏ∂úÏùÑ ÏãúÎèÑÌñàÏäµÎãàÎã§.", 'info'); return; }
                const skill = player.skills.find(s => s.id === 'shadow_extract');
                if (!skill) return;
                if (player.mp < skill.mpCost) { addLog("ÎßàÎ†•Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.", 'danger'); return; }

                setExtractionAttempted(true);
                updatePlayer({ mp: player.mp - skill.mpCost });
                addLog("Í∑∏Î¶ºÏûê Ï∂îÏ∂úÏùÑ ÏãúÎèÑÌï©ÎãàÎã§...", 'system');
                setCombatAnim('EXTRACTION');

                const successChance = 40 + (player.stats.intelligence * 0.5);
                const roll = Math.random() * 100;
                
                setTimeout(() => {
                    setCombatAnim('IDLE');
                    if (roll < successChance) {
                        const enemyName = lastDefeatedEnemy.name;
                        let shadowName = `Í∑∏Î¶ºÏûê ${enemyName}`;
                        let role = "Î≥¥Î≥ë";
                        let bonusMult = 0.8; 

                        if (lastDefeatedEnemy.isBoss) {
                            shadowName = `[Ïû•Íµ∞] ${enemyName}`; role = "Ïû•Íµ∞"; bonusMult = 1.5;
                        } else if (/ÎßàÎ≤ï|Ï£ºÏà†|ÌôîÏóº|ÏñºÏùå|Î©îÏù¥ÏßÄ|ÏúÑÏûêÎìú/.test(enemyName)) {
                            shadowName = enemyName.replace(/ÎßàÎ≤ïÏÇ¨|Ï£ºÏà†ÏÇ¨|ÌôîÏóº|ÏñºÏùå/, '').trim() + " (Î©îÏù¥ÏßÄ)"; role = "ÎßàÎ≤ïÏÇ¨"; bonusMult = 1.3;
                        } else if (/Í≥®Î†ò|Î∞©Ìå®|Í±∞Ïù∏|ÏïÑÏù¥Ïñ∏|Í∞ÄÎîîÏñ∏/.test(enemyName)) {
                            shadowName = enemyName.replace(/Í≥®Î†ò/, '').trim() + " (Í∞ÄÎîîÏñ∏)"; role = "ÌÉ±Ïª§"; bonusMult = 0.5;
                        } else if (/ÏïîÏÇ¥|ÎäëÎåÄ|Îã®Í≤Ä|Ïä§ÌååÏù¥Îçî|Í∑∏Î¶ºÏûê/.test(enemyName)) {
                            shadowName = enemyName.replace(/ÏïîÏÇ¥Ïûê/, '').trim() + " (Ïñ¥ÏåîÏã†)"; role = "ÏïîÏÇ¥Ïûê"; bonusMult = 1.2;
                        } else if (/Í∏∞ÏÇ¨|ÎÇòÏù¥Ìä∏|Ïò§ÌÅ¨|Î¶¨ÏûêÎìú|Í≤ÄÏÇ¨/.test(enemyName)) {
                            shadowName = enemyName.replace(/Í∏∞ÏÇ¨/, '').trim() + " (ÎÇòÏù¥Ìä∏)"; role = "Ï†ÑÏÇ¨"; bonusMult = 1.0;
                        }

                        const newCompanion = {
                            id: `shadow_${Date.now()}`,
                            name: shadowName,
                            rank: lastDefeatedEnemy.rank,
                            description: `${lastDefeatedEnemy.name}Ïùò Í∑∏Î¶ºÏûêÏûÖÎãàÎã§.`,
                            type: 'SHADOW',
                            role: role,
                            attackBonus: Math.max(1, Math.floor(lastDefeatedEnemy.attack * bonusMult))
                        };
                        const updatedCompanions = [...player.companions, newCompanion];
                        updatePlayer({ companions: updatedCompanions });
                        addLog(`ÏÑ±Í≥µÌñàÏäµÎãàÎã§! ${newCompanion.name}(Ïù¥)Í∞Ä Í∑∏Î¶ºÏûê Íµ∞Îã®Ïóê Ìï©Î•òÌï©ÎãàÎã§.`, 'gain');
                    } else {
                        addLog("Ï∂îÏ∂úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏòÅÌòºÏù¥ ÏÜåÎ©∏ÎêòÏóàÏäµÎãàÎã§.", 'info');
                    }
                }, 2000);
            };

            const handleBuyItem = (item) => {
                if (player.gold < item.price) { addLog("Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.", 'danger'); return; }
                const newInventory = [...player.inventory];
                if (item.type === 'CONSUMABLE') {
                    const existingItem = newInventory.find(i => i.id === item.id);
                    if (existingItem) existingItem.count = (existingItem.count || 0) + 1;
                    else newInventory.push({ ...item, count: 1 });
                } else {
                    newInventory.push({ ...item, uid: Date.now().toString() + Math.random().toString().slice(2), isEquipped: false });
                }
                updatePlayer({ gold: player.gold - item.price, inventory: newInventory });
                addLog(`${item.name}ÏùÑ(Î•º) Íµ¨Îß§ÌñàÏäµÎãàÎã§.`, 'gain');
            };

            const handleSellItem = (item, index) => {
                if (item.isEquipped) {
                    addLog("Ïû•Ï∞© Ï§ëÏù∏ ÏïÑÏù¥ÌÖúÏùÄ ÌåêÎß§Ìï† Ïàò ÏóÜÏäµÎãàÎã§.", 'danger');
                    return;
                }
                const sellPrice = Math.floor(item.price * 0.5); 
                const newInventory = [...player.inventory];
                if (item.type === 'CONSUMABLE' && item.count > 1) {
                    newInventory[index].count -= 1;
                } else {
                    newInventory.splice(index, 1);
                }
                updatePlayer({ gold: player.gold + sellPrice, inventory: newInventory });
                addLog(`${item.name}ÏùÑ(Î•º) ${sellPrice}GÏóê ÌåêÎß§ÌñàÏäµÎãàÎã§.`, 'gain');
            };

            const handleUseItem = (itemId) => {
                const itemIndex = player.inventory.findIndex(i => i.id === itemId);
                if (itemIndex === -1) return;
                const item = player.inventory[itemIndex];
                if (item.type !== 'CONSUMABLE') return;
                let used = false;
                if (item.id === 'elixir') {
                    updatePlayer({ hp: player.maxHp, mp: player.maxMp });
                    addLog(`${item.name} ÏÇ¨Ïö©. Î™®Îì† ÏÉÅÌÉúÍ∞Ä ÌöåÎ≥µÎêòÏóàÏäµÎãàÎã§!`, 'gain');
                    used = true;
                } else if (item.id.includes('hp')) {
                    if (player.hp >= player.maxHp) { addLog("Ï≤¥Î†•Ïù¥ Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§.", 'info'); return; }
                    updatePlayer({ hp: Math.min(player.maxHp, player.hp + item.effectValue) });
                    used = true;
                } else if (item.id.includes('mp')) {
                    if (player.mp >= player.maxMp) { addLog("ÎßàÎ†•Ïù¥ Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§.", 'info'); return; }
                    updatePlayer({ mp: Math.min(player.maxMp, player.mp + item.effectValue) });
                    used = true;
                }
                if (used) {
                    const newInventory = [...player.inventory];
                    if ((item.count || 1) > 1) newInventory[itemIndex].count -= 1;
                    else newInventory.splice(itemIndex, 1);
                    updatePlayer({ inventory: newInventory });
                    addLog(`${item.name} ÏÇ¨Ïö©.`, 'gain');
                }
            };

            const handleGacha = () => {
                const GACHA_COST = 400;
                
                // Check for Free Ticket
                const ticketIndex = player.inventory.findIndex(i => i.id === 'gacha_ticket');
                const hasTicket = ticketIndex !== -1 && (player.inventory[ticketIndex].count || 0) > 0;
                
                if (!hasTicket && player.gold < GACHA_COST) { addLog("Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.", 'danger'); return; }
                
                if (hasTicket) {
                    // Use Ticket
                    const newInventory = [...player.inventory];
                    if (newInventory[ticketIndex].count > 1) {
                        newInventory[ticketIndex].count -= 1;
                    } else {
                        newInventory.splice(ticketIndex, 1);
                    }
                    updatePlayer({ inventory: newInventory });
                    addLog(`[ÎûúÎç§ Î∞ïÏä§] Î¨¥Î£å ÎΩëÍ∏∞Í∂åÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ ÏÉÅÏûêÎ•º ÏóΩÎãàÎã§...`, 'system');
                } else {
                    // Use Gold
                    updatePlayer({ gold: player.gold - GACHA_COST });
                    addLog(`[ÎûúÎç§ Î∞ïÏä§] 400Í≥®ÎìúÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÏÉÅÏûêÎ•º ÏóΩÎãàÎã§...`, 'system');
                }
                
                const roll = Math.random() * 100;
                let resultType = 'FAIL';
                
                if (roll >= 50 && roll < 70) resultType = 'GOLD';
                else if (roll >= 70 && roll < 80) resultType = 'ARMOR';
                else if (roll >= 80 && roll < 90) resultType = 'DAGGER';
                else if (roll >= 90 && roll < 99.5) resultType = 'SWORD';
                else if (roll >= 99.5) resultType = 'DEMON';
                
                setTimeout(() => {
                    if (resultType === 'FAIL') {
                        addLog("ÍΩù! ÏÉÅÏûê ÏïàÏóêÎäî ÏïÑÎ¨¥Í≤ÉÎèÑ ÏóÜÏóàÏäµÎãàÎã§.", 'info');
                    } else if (resultType === 'GOLD') {
                        setTimeout(() => updatePlayer({ gold: player.gold + 1000 }), 50); 
                        addLog("Ï∂ïÌïòÌï©ÎãàÎã§! 1,000 Í≥®ÎìúÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§.", 'gain');
                    } else if (resultType === 'ARMOR') {
                        const armor = { id: `gacha_armor_${Date.now()}`, name: 'Í∑∏Î¶ºÏûê Íµ∞Ï£ºÏùò Í∞ëÏ£º', type: 'ARMOR', slot: 'BODY', description: 'Íµ∞Ï£ºÏùò ÏúÑÏóÑÏù¥ ÏÑúÎ¶∞ Í∞ëÏò∑. (Î∞©Ïñ¥Î†• +80)', price: 0, effectValue: 80, uid: Date.now().toString(), isEquipped: false };
                        const newInv = [...player.inventory, armor];
                        updatePlayer({ inventory: newInv });
                        addLog("ÎåÄÎ∞ï! [Í∑∏Î¶ºÏûê Íµ∞Ï£ºÏùò Í∞ëÏ£º]Î•º ÌöçÎìùÌñàÏäµÎãàÎã§!", 'gain');
                    } else if (resultType === 'DAGGER') {
                        const dagger = { id: `gacha_dagger_${Date.now()}`, name: 'Í∑∏Î¶ºÏûê Íµ∞Ï£ºÏùò Îã®Í≤Ä', type: 'WEAPON', slot: 'WEAPON', description: 'Ïñ¥Îë†ÏùÑ Í∞ÄÎ•¥Îäî Îã®Í≤Ä. (Í≥µÍ≤©Î†• +150)', price: 0, effectValue: 150, uid: Date.now().toString(), isEquipped: false };
                        const newInv = [...player.inventory, dagger];
                        updatePlayer({ inventory: newInv });
                        addLog("ÎåÄÎ∞ï! [Í∑∏Î¶ºÏûê Íµ∞Ï£ºÏùò Îã®Í≤Ä]ÏùÑ ÌöçÎìùÌñàÏäµÎãàÎã§!", 'gain');
                    } else if (resultType === 'SWORD') {
                        const sword = { id: `gacha_sword_${Date.now()}`, name: 'Í∑∏Î¶ºÏûê Íµ∞Ï£ºÏùò Ïû•Í≤Ä', type: 'WEAPON', slot: 'WEAPON', description: 'Íµ∞Ï£ºÍ∞Ä ÌúòÎëêÎ•¥Îçò Í≤Ä. (Í≥µÍ≤©Î†• +200)', price: 0, effectValue: 200, uid: Date.now().toString(), isEquipped: false };
                        const newInv = [...player.inventory, sword];
                        updatePlayer({ inventory: newInv });
                        addLog("Ï¥àÎåÄÎ∞ï! [Í∑∏Î¶ºÏûê Íµ∞Ï£ºÏùò Ïû•Í≤Ä]ÏùÑ ÌöçÎìùÌñàÏäµÎãàÎã§!", 'gain');
                    } else if (resultType === 'DEMON') {
                        const demon = { id: `demon_${Date.now()}`, name: 'Í∑∏Î¶ºÏûê ÌÉÄÎùΩÌïú ÏïÖÎßà', rank: Rank.S, description: 'Ïã¨Ïó∞ÏóêÏÑú ÎèåÏïÑÏò® ÏïÖÎßà', type: 'SHADOW', role: 'ÏïÖÎßà', attackBonus: 300 };
                        const newComps = [...player.companions, demon];
                        updatePlayer({ companions: newComps });
                        addLog("Í∏∞Ï†ÅÏûÖÎãàÎã§! [Í∑∏Î¶ºÏûê ÌÉÄÎùΩÌïú ÏïÖÎßà]Í∞Ä ÏÜåÌôòÎêòÏóàÏäµÎãàÎã§!", 'gain');
                    }
                }, 1000);
            };

            const handlePatrol = () => {
                if (player.hp < 15) { addLog("Ï≤¥Î†•Ïù¥ Î∂ÄÏ°±ÌïòÏó¨ ÏàúÏ∞∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.", 'danger'); return; }
                updatePlayer({ 
                    hp: player.hp - 10, 
                    gold: player.gold + 50, 
                    currentExp: player.currentExp + 15 
                });
                addLog(`ÏàúÏ∞∞ÏùÑ ÏôÑÎ£åÌñàÏäµÎãàÎã§. (Ï≤¥Î†• -10, +50G, +15EXP)`, 'gain');
            };

            const getTicketCount = () => {
                const ticket = player.inventory.find(i => i.id === 'gacha_ticket');
                return ticket ? (ticket.count || 0) : 0;
            };

            if (gameState === 'COMBAT' && currentEnemy) {
                return (
                    <div className={`flex-1 flex flex-col gap-4 p-4 bg-red-900/10 border border-red-500/30 rounded-lg relative min-h-[400px] overflow-hidden transition-all duration-200
                        ${combatAnim === 'HIT' ? 'animate-damage-shake border-red-600 bg-red-900/40 shadow-[inset_0_0_50px_rgba(220,38,38,0.5)]' : ''}
                        ${combatAnim === 'SKILL' ? 'animate-skill-flash shadow-[inset_0_0_30px_rgba(59,130,246,0.3)]' : ''}
                        ${combatAnim === 'ATTACK' ? 'shadow-[inset_0_0_20px_rgba(255,255,255,0.1)]' : ''}
                    `}>
                        <div className="absolute top-2 right-4 text-red-500 font-bold text-xl tracking-wider animate-pulse z-10">
                            COMBAT {dungeonProgress.active && <span className="text-sm text-gray-400 block text-right">WAVE {dungeonProgress.current}/5</span>}
                        </div>
                        {combatAnim === 'ATTACK' && <div className="absolute inset-0 z-30 flex items-center justify-center pointer-events-none"><div className="w-[120%] h-1 bg-white shadow-[0_0_15px_white] rotate-45 animate-pulse"></div></div>}
                        {combatAnim === 'EXTRACTION' && <div className="absolute inset-0 z-40 flex items-center justify-center pointer-events-none bg-purple-900/60 animate-pulse"><span className="text-6xl">üëª</span></div>}
                        
                        <div className={`flex flex-col items-center justify-center flex-1 py-4 relative z-10 ${combatAnim === 'HIT' ? 'scale-110 brightness-150' : ''}`}>
                            <div className="text-6xl mb-4 animate-bounce">{currentEnemy.isBoss ? 'üëπ' : 'üëæ'}</div>
                            <h3 className="text-2xl font-bold text-red-400">{currentEnemy.name} <span className="text-sm text-gray-400">({currentEnemy.rank}Í∏â)</span></h3>
                            <div className="w-full max-w-md mt-4 px-4">
                                <div className="flex justify-between text-sm text-red-300 mb-1">
                                    <span>HP</span>
                                    <span>{Math.max(0, currentEnemy.hp)} / {currentEnemy.maxHp}</span>
                                </div>
                                <div className="h-4 bg-gray-900 rounded-full border border-red-900/50 overflow-hidden relative">
                                    <div className="h-full bg-red-600 transition-all duration-200" style={{ width: `${Math.max(0, (currentEnemy.hp / currentEnemy.maxHp) * 100)}%` }}></div>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-2 mt-auto">
                            <button onClick={handleAttack} className="p-3 bg-gray-800 hover:bg-red-900 border border-gray-600 rounded text-white font-bold">
                                ‚öîÔ∏è Í∏∞Î≥∏ Í≥µÍ≤©
                            </button>
                            {player.skills.map(skill => (
                                skill.effect !== 'summon' && (
                                <button key={skill.id} onClick={() => handleSkillUse(skill)} disabled={player.mp < skill.mpCost} className="p-3 bg-gray-800 hover:bg-blue-900 border border-gray-600 rounded text-white disabled:opacity-30">
                                    <span className="font-bold">{skill.name}</span> <span className="text-xs text-blue-300">({skill.mpCost} MP)</span>
                                </button>
                                )
                            ))}
                            <div className="col-span-2 flex gap-2 mt-2">
                                {player.inventory.filter(i => i.type === 'CONSUMABLE').map((item) => (
                                    <button key={item.id} onClick={() => handleUseItem(item.id)} className="flex-1 py-2 px-3 bg-gray-800 hover:bg-green-900 border border-gray-600 rounded text-xs text-gray-300 flex justify-between">
                                        <span>üíä {item.name}</span><span>x{item.count}</span>
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => { addLog("ÎèÑÎßùÏ≥§ÏäµÎãàÎã§!", 'info'); setGameState('IDLE'); setCurrentEnemy(null); setDungeonProgress({active:false, current:0, total:0, rank:null, theme:''}); }} className="col-span-2 p-2 text-xs text-gray-500 hover:text-white mt-2">
                                üèÉ ÎèÑÎßùÍ∞ÄÍ∏∞
                            </button>
                        </div>
                    </div>
                );
            }

            if (gameState === 'VICTORY' && lastDefeatedEnemy) {
                return (
                    <div className="flex-1 flex flex-col items-center justify-center gap-6 p-6 bg-blue-900/10 border border-system-blue/50 rounded-lg">
                        <div className="text-4xl font-bold text-system-blue animate-pulse">VICTORY</div>
                        <div className="text-center">
                            <p className="text-xl text-gray-300 mb-2">{lastDefeatedEnemy.name} Ï≤òÏπò!</p>
                            <p className="text-sm text-gray-500">Í≤ΩÌóòÏπòÏôÄ Í≥®ÎìúÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§.</p>
                        </div>
                        <div className="flex flex-col gap-3 w-full max-w-xs">
                            {player.skills.some(s => s.id === 'shadow_extract') && (
                                <button onClick={handleExtraction} disabled={extractionAttempted || player.mp < 100} className={`py-4 px-6 rounded border border-purple-500 text-purple-300 font-bold ${extractionAttempted ? 'bg-gray-900 opacity-50' : 'bg-purple-900/30 hover:bg-purple-900/60'}`}>
                                    Í∑∏Î¶ºÏûê Ï∂îÏ∂ú (MP 100)
                                </button>
                            )}
                            
                            {dungeonProgress.active && dungeonProgress.current < dungeonProgress.total ? (
                                <button onClick={handleNextDungeonWave} className="py-3 px-6 bg-red-900/50 hover:bg-red-800 rounded text-white font-bold border border-red-500 animate-pulse">
                                    Îã§Ïùå Íµ¨Ïó≠ÏúºÎ°ú Ïù¥Îèô (Wave {dungeonProgress.current + 1}/5)
                                </button>
                            ) : (
                                <button onClick={() => { setGameState('IDLE'); setLastDefeatedEnemy(null); setExtractionAttempted(false); setActiveStoryId(null); setDungeonProgress({active: false, current:0, total:0, rank:null, theme:''}); }} className="py-3 px-6 bg-gray-800 hover:bg-gray-700 rounded text-white font-bold border border-gray-600">
                                    {dungeonProgress.active ? "ÎçòÏ†Ñ ÌÅ¥Î¶¨Ïñ¥ (ÎßàÏùÑÎ°ú Î≥µÍ∑Ä)" : "ÎèåÏïÑÍ∞ÄÍ∏∞"}
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex-1 flex flex-col gap-4">
                    <div className="flex gap-2 bg-system-panel p-2 rounded border border-gray-800">
                        <button onClick={() => { if(player.hp < 10) return; updatePlayer({ hp: player.hp - 5, currentExp: player.currentExp + 10 }); addLog("ÌõàÎ†®ÏùÑ ÏàòÌñâÌñàÏäµÎãàÎã§. (+10 EXP)", 'gain'); }} className="flex-1 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm">üí™ ÌõàÎ†®ÌïòÍ∏∞</button>
                        <button onClick={handlePatrol} className="flex-1 py-2 bg-gray-800 hover:bg-blue-900/30 rounded text-sm border border-transparent hover:border-blue-500/30">üõ°Ô∏è ÏàúÏ∞∞(ÏÉÅÏãú ÌÄòÏä§Ìä∏)</button>
                        <button onClick={() => { updatePlayer({ hp: Math.min(player.maxHp, player.hp + player.maxHp*0.5), mp: Math.min(player.maxMp, player.mp + player.maxMp*0.5) }); addLog("Ìú¥ÏãùÏùÑ Ï∑®ÌñàÏäµÎãàÎã§.", 'gain'); }} className="flex-1 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm">üí§ Ìú¥ÏãùÌïòÍ∏∞</button>
                    </div>

                    <div className="flex border-b border-gray-700">
                        <button onClick={() => setActiveTab('STORY')} className={`flex-1 py-3 font-bold ${activeTab === 'STORY' ? 'text-system-blue border-b-2 border-system-blue' : 'text-gray-500'}`}>Ïä§ÌÜ†Î¶¨</button>
                        <button onClick={() => setActiveTab('DUNGEON')} className={`flex-1 py-3 font-bold ${activeTab === 'DUNGEON' ? 'text-system-blue border-b-2 border-system-blue' : 'text-gray-500'}`}>ÎçòÏ†Ñ</button>
                        {player.level >= 5 && <button onClick={() => setActiveTab('SHOP')} className={`flex-1 py-3 font-bold ${activeTab === 'SHOP' ? 'text-yellow-500 border-b-2 border-yellow-500' : 'text-gray-500'}`}>ÏÉÅÏ†ê</button>}
                    </div>

                    <div className="flex-1 overflow-y-auto min-h-[300px]">
                        {activeTab === 'STORY' && (
                            <div className="space-y-3">
                                {STORIES.map((story, index) => {
                                    const isLocked = index > player.storyStage;
                                    const isCompleted = index < player.storyStage;
                                    return (
                                        <div key={story.id} className={`relative p-4 rounded border ${isLocked ? 'border-gray-800 bg-gray-900/50 opacity-50' : isCompleted ? 'border-green-900 bg-green-900/10' : 'border-system-blue bg-system-blue/10'}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <h4 className={`font-bold ${isCompleted ? 'text-green-500' : isLocked ? 'text-gray-500' : 'text-system-blue'}`}>{story.title}</h4>
                                                <span className="text-xs bg-gray-900 px-2 py-1 rounded text-gray-300">Lv.{story.requiredLevel}+</span>
                                            </div>
                                            <p className="text-sm text-gray-400 mb-4">{story.description}</p>
                                            {!isCompleted && !isLocked && (
                                                <button onClick={() => handleStartStory(story.id)} className="w-full py-2 bg-system-blue hover:bg-blue-600 text-black font-bold rounded">Ïä§ÌÜ†Î¶¨ ÏãúÏûë</button>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        {activeTab === 'DUNGEON' && (
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                {loading ? <div className="col-span-2 text-center py-10 text-system-blue animate-pulse">ÎçòÏ†Ñ ÌÉêÏÉâ Ï§ë...</div> :
                                [
                                    { r: Rank.E, t: "ÏßÄÌïò ÏàòÎ°ú" },
                                    { r: Rank.D, t: "Í≥†Î∏îÎ¶∞ Ïà≤" },
                                    { r: Rank.C, t: "Ïò§ÌÅ¨Ïùò Îä™ÏßÄÎåÄ" },
                                    { r: Rank.B, t: "Í≥®Î†òÏùò Í¥ëÏÇ∞" },
                                    { r: Rank.B, t: "ÏñºÏùå ÎèôÍµ¥" },
                                    { r: Rank.A, t: "ÏÑ§Ïõê (Red Gate)" },
                                    { r: Rank.A, t: "ÌôîÏÇ∞ ÏßÄÎåÄ" },
                                    { r: Rank.S, t: "Ï†úÏ£ºÎèÑ (Í∞úÎØ∏Íµ¥)" }
                                ].map((dungeon, idx) => (
                                    <button key={idx} onClick={() => handleEnterDungeon(dungeon.r, dungeon.t)} className="p-4 text-left rounded border border-gray-700 bg-gray-800/30 hover:bg-gray-700 hover:border-system-blue group">
                                        <div className="font-bold text-gray-300 group-hover:text-system-blue">{dungeon.r}Í∏â - {dungeon.t}</div>
                                        <div className="text-xs text-gray-500">ÏûÖÏû•ÌïòÍ∏∞ (5 Waves) &rarr;</div>
                                    </button>
                                ))}
                            </div>
                        )}
                        {activeTab === 'SHOP' && (
                            <div className="space-y-4">
                                <div className="flex border-b border-gray-800 mb-2">
                                     <button onClick={() => setShopMode('BUY')} className={`flex-1 py-2 text-xs font-bold ${shopMode === 'BUY' ? 'bg-yellow-900/20 text-yellow-400 border-b border-yellow-400' : 'text-gray-500'}`}>Íµ¨Îß§ÌïòÍ∏∞</button>
                                     <button onClick={() => setShopMode('SELL')} className={`flex-1 py-2 text-xs font-bold ${shopMode === 'SELL' ? 'bg-red-900/20 text-red-400 border-b border-red-400' : 'text-gray-500'}`}>ÌåêÎß§ÌïòÍ∏∞ (50%)</button>
                                </div>
                                
                                {shopMode === 'BUY' ? (
                                <>
                                    <div className="p-4 bg-gradient-to-r from-purple-900/20 to-blue-900/20 rounded border border-purple-500/50 flex flex-col items-center gap-3 relative overflow-hidden">
                                        <h3 className="text-lg font-bold text-purple-400 z-10">üéÅ ÎûúÎç§ Î∞ïÏä§ (Lucky Draw)</h3>
                                        <p className="text-xs text-gray-400 text-center z-10">
                                            ÍΩù 50% | 1000G 20% | Íµ∞Ï£ºÏùò Ïû•ÎπÑ 29.5% | ??? 0.5%
                                        </p>
                                        <button 
                                            onClick={handleGacha}
                                            className="z-10 px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded shadow-[0_0_15px_rgba(168,85,247,0.5)] transition-all flex flex-col items-center"
                                        >
                                            {getTicketCount() > 0 ? (
                                                <>
                                                    <span>Î¨¥Î£å ÎΩëÍ∏∞Í∂å ÏÇ¨Ïö©</span>
                                                    <span className="text-[10px] text-purple-200">ÎÇ®ÏùÄ Ìã∞Ïºì: {getTicketCount()}Ïû•</span>
                                                </>
                                            ) : (
                                                <span>400 GoldÎ°ú ÎΩëÍ∏∞</span>
                                            )}
                                        </button>
                                        {/* Background Effect */}
                                        <div className="absolute top-0 right-0 p-4 opacity-10 text-6xl">üé≤</div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 p-2">
                                        {SHOP_ITEMS.map((item) => (
                                            <div key={item.id} className="flex justify-between items-center p-3 bg-gray-900/60 border border-gray-700 rounded hover:border-yellow-600">
                                                <div>
                                                    <div className="font-bold text-white">{item.name}</div>
                                                    <div className="text-xs text-gray-500">{item.description}</div>
                                                </div>
                                                <button onClick={() => handleBuyItem(item)} className="bg-gray-800 hover:bg-yellow-800 px-3 py-1 rounded text-yellow-400 font-mono text-sm border border-gray-600">
                                                    {item.price} G
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 p-2">
                                        {player.inventory.length === 0 && <div className="col-span-2 text-center text-gray-500 py-10">ÌåêÎß§Ìï† ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏäµÎãàÎã§.</div>}
                                        {player.inventory.map((item, idx) => (
                                            <div key={`${item.id}-${idx}`} className="flex justify-between items-center p-3 bg-gray-900/60 border border-gray-700 rounded hover:border-red-600">
                                                <div>
                                                    <div className="font-bold text-white">{item.name} {item.count && `x${item.count}`}</div>
                                                    <div className="text-xs text-gray-500">{item.isEquipped ? 'Ïû•Ï∞© Ï§ë (ÌåêÎß§Î∂àÍ∞Ä)' : `ÌåêÎß§Í∞Ä: ${Math.floor(item.price * 0.5)} G`}</div>
                                                </div>
                                                <button 
                                                    onClick={() => handleSellItem(item, idx)} 
                                                    disabled={item.isEquipped}
                                                    className="bg-gray-800 hover:bg-red-900 px-3 py-1 rounded text-red-400 font-mono text-sm border border-gray-600 disabled:opacity-30 disabled:cursor-not-allowed"
                                                >
                                                    ÌåêÎß§
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const INITIAL_PLAYER = {
                name: "",
                level: 1,
                currentExp: 0,
                maxExp: 100,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                gold: 0,
                stats: { strength: 10, agility: 10, sense: 10, vitality: 10, intelligence: 10 },
                statPoints: 0,
                job: PlayerClass.NONE,
                title: "ÏÉàÎÇ¥Í∏∞ ÌóåÌÑ∞",
                skills: [{ id: 'sprint', name: 'Ï†ÑÎ†• ÏßàÏ£º', description: 'Ïù¥Îèô ÏÜçÎèÑÍ∞Ä Îπ®ÎùºÏßëÎãàÎã§.', mpCost: 5, cooldown: 3, level: 1 }],
                companions: [],
                inventory: [],
                storyStage: 0
            };

            const [gameStarted, setGameStarted] = useState(() => {
                return !!localStorage.getItem('SL_RPG_SAVE_V1');
            });
            const [playerNameInput, setPlayerNameInput] = useState("");
            const [logs, setLogs] = useState([]);
            const [isLevelUp, setIsLevelUp] = useState(false);
            const [selectedSkillForUpgrade, setSelectedSkillForUpgrade] = useState(null);
            const [isCodeModalOpen, setIsCodeModalOpen] = useState(false);
            const [codeInput, setCodeInput] = useState("");

            const [player, setPlayer] = useState(() => {
                const saved = localStorage.getItem('SL_RPG_SAVE_V1');
                return saved ? JSON.parse(saved) : INITIAL_PLAYER;
            });

            // Auto Save when player state changes
            useEffect(() => {
                if (gameStarted) {
                    localStorage.setItem('SL_RPG_SAVE_V1', JSON.stringify(player));
                }
            }, [player, gameStarted]);

            const handleManualSave = () => {
                localStorage.setItem('SL_RPG_SAVE_V1', JSON.stringify(player));
                addLog("Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.", 'system');
                alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
            };

            const handleResetGame = () => {
                if(confirm("Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÍ≥† Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                    localStorage.removeItem('SL_RPG_SAVE_V1');
                    window.location.reload();
                }
            };

            const addLog = useCallback((text, type = 'info') => {
                setLogs(prev => [...prev, { id: Date.now() + Math.random(), text, type, timestamp: Date.now() }].slice(-50));
            }, []);

            useEffect(() => {
                if (!gameStarted) return;
                // Check Level Up
                if (player.currentExp >= player.maxExp) {
                    const leftoverExp = player.currentExp - player.maxExp;
                    const newLevel = player.level + 1;
                    const hpGrowth = 20 + (player.stats.vitality * 2);
                    const mpGrowth = 10 + (player.stats.intelligence * 2);
                    
                    let newSkills = [...player.skills];
                    if (newLevel === 5 && !newSkills.find(s => s.id === 'vital_strike')) {
                        newSkills.push({ id: 'vital_strike', name: 'Í∏âÏÜå Ï∞åÎ•¥Í∏∞', description: 'Ï†ÅÏùò ÏïΩÏ†êÏùÑ Í≥µÍ≤©Ìï©ÎãàÎã§. (200%)', mpCost: 15, cooldown: 2, damageMult: 2.0, level: 1 });
                        addLog("„ÄêÏä§ÌÇ¨ ÌöçÎìù„Äë 'Í∏âÏÜå Ï∞åÎ•¥Í∏∞'Î•º Î∞∞Ïõ†ÏäµÎãàÎã§.", 'system');
                    }
                    if ((newLevel >= 20 || player.job === PlayerClass.NECROMANCER) && !newSkills.find(s => s.id === 'shadow_extract')) {
                        newSkills.push({ id: 'shadow_extract', name: 'Í∑∏Î¶ºÏûê Ï∂îÏ∂ú', description: 'Ïì∞Îü¨ÏßÑ Ï†ÅÏùÑ Î≥ëÏÇ¨Î°ú ÎßåÎì≠ÎãàÎã§.', mpCost: 100, cooldown: 0, effect: 'summon', level: 1 });
                        addLog("„ÄêÏä§ÌÇ¨ ÌöçÎìù„Äë 'Í∑∏Î¶ºÏûê Ï∂îÏ∂ú'ÏùÑ Î∞∞Ïõ†ÏäµÎãàÎã§.", 'system');
                    }

                    setPlayer(prev => ({
                        ...prev,
                        level: newLevel,
                        currentExp: leftoverExp,
                        maxExp: Math.floor(prev.maxExp * 1.3),
                        maxHp: prev.maxHp + hpGrowth,
                        hp: prev.maxHp + hpGrowth,
                        maxMp: prev.maxMp + mpGrowth,
                        mp: prev.maxMp + mpGrowth,
                        statPoints: prev.statPoints + 3,
                        skills: newSkills
                    }));
                    setIsLevelUp(true);
                    addLog(`Î†àÎ≤® ÏóÖ! Lv.${newLevel} Îã¨ÏÑ±!`, 'system');
                }
            }, [player.currentExp, player.maxExp, gameStarted, addLog, player.stats]);

            const handleStartGame = () => {
                if (!playerNameInput.trim()) return;
                setPlayer(prev => ({ ...prev, name: playerNameInput }));
                setGameStarted(true);
                setTimeout(() => {
                    addLog("ÏãúÏä§ÌÖúÍ≥º ÎèôÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.", 'system');
                    addLog(`ÌîåÎ†àÏù¥Ïñ¥ '${playerNameInput}'Îãò, ÌôòÏòÅÌï©ÎãàÎã§.`, 'system');
                }, 100);
            };

            const handleContinueGame = () => {
                setGameStarted(true);
                setTimeout(() => {
                    addLog("Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§.", 'system');
                    addLog(`ÌîåÎ†àÏù¥Ïñ¥ '${player.name}'Îãò, Îã§Ïãú ÎèåÏïÑÏò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§.`, 'system');
                }, 100);
            };

            const handleEnemyDefeated = (rank, exp, gold, storyId) => {
                let updates = { currentExp: player.currentExp + exp, gold: player.gold + gold };
                if (storyId !== undefined && storyId === player.storyStage) {
                    addLog(`„ÄêÏä§ÌÜ†Î¶¨ ÏôÑÎ£å„Äë Ï±ïÌÑ∞ ${storyId + 1} ÌÅ¥Î¶¨Ïñ¥!`, 'system');
                    updates.storyStage = player.storyStage + 1;
                    if (storyId === 1) { 
                        updates.job = PlayerClass.NECROMANCER;
                        updates.title = "Í∑∏Î¶ºÏûê Íµ∞Ï£º";
                        addLog("„ÄêÏ†ÑÏßÅ„Äë ÎÑ§ÌÅ¨Î°úÎß®ÏÑúÎ°ú Ï†ÑÏßÅÌñàÏäµÎãàÎã§.", 'system');
                        const igris = { id: 'igris', name: 'Ïù¥Í∑∏Î¶¨Ïä§', rank: Rank.A, description: 'ÌïèÎπõÏùò Í∏∞ÏÇ¨Îã®Ïû•', type: 'SHADOW', role: 'Í∏∞ÏÇ¨Îã®Ïû•', attackBonus: 50 };
                        updates.companions = [...player.companions, igris];
                        addLog("Í∑∏Î¶ºÏûê Î≥ëÏÇ¨ 'Ïù¥Í∑∏Î¶¨Ïä§'Î•º ÌöçÎìùÌñàÏäµÎãàÎã§.", 'gain');
                    }
                    if (storyId === 2) {
                        const iron = { id: 'iron', name: 'ÏïÑÏù¥Ïñ∏', rank: Rank.A, description: 'Í∞ïÏ≤†Ïùò Ïú°Ï≤¥', type: 'SHADOW', role: 'ÌÉ±Ïª§', attackBonus: 40 };
                        updates.companions = [...(updates.companions || player.companions), iron];
                        addLog("Í∑∏Î¶ºÏûê Î≥ëÏÇ¨ 'ÏïÑÏù¥Ïñ∏'ÏùÑ ÌöçÎìùÌñàÏäµÎãàÎã§.", 'gain');
                    }
                    if (storyId === 4) {
                        const beru = { id: 'beru', name: 'Î≤†Î•¥', rank: Rank.S, description: 'Í∞úÎØ∏Ïùò Ïôï', type: 'SHADOW', role: 'Íµ∞Îã®Ïû•', attackBonus: 200 };
                        updates.companions = [...(updates.companions || player.companions), beru];
                        addLog("Í∑∏Î¶ºÏûê Î≥ëÏÇ¨ 'Î≤†Î•¥'Î•º ÌöçÎìùÌñàÏäµÎãàÎã§.", 'gain');
                    }
                }
                setPlayer(prev => ({ ...prev, ...updates }));
            };

            const handleToggleEquip = (item) => {
                if (item.type === 'CONSUMABLE') return;
                setPlayer(prev => {
                    const newInventory = [...prev.inventory];
                    const targetIndex = newInventory.findIndex(i => i.uid === item.uid);
                    if (targetIndex === -1) return prev;
                    const target = newInventory[targetIndex];
                    if (target.isEquipped) {
                        newInventory[targetIndex].isEquipped = false;
                        addLog(`${target.name} Ìï¥Ï†ú.`, 'info');
                    } else {
                        newInventory.forEach(i => { if (i.slot === target.slot) i.isEquipped = false; });
                        newInventory[targetIndex].isEquipped = true;
                        addLog(`${target.name} Ïû•Ï∞©.`, 'gain');
                    }
                    return { ...prev, inventory: newInventory };
                });
            };

            const handleSubmitCode = () => {
                setIsCodeModalOpen(false);
                const code = codeInput.trim();
                
                if (code === 'hello') {
                    // Elixir x20
                    const elixirs = { id: 'elixir', name: 'ÏóòÎ¶≠ÏÑú', type: 'CONSUMABLE', description: 'Ï≤¥Î†•Í≥º ÎßàÎ†•ÏùÑ ÏôÑÏ†ÑÌûà ÌöåÎ≥µÌï©ÎãàÎã§.', price: 5000, effectValue: 9999, count: 20 };
                    // Knight Killer x2
                    const killers = [
                        { id: 'knight_killer', name: 'ÎÇòÏù¥Ìä∏ ÌÇ¨Îü¨', type: 'WEAPON', slot: 'WEAPON', description: 'Í∞ëÏò∑ÏùÑ Îö´Îäî Îã®Í≤Ä. (Í≥µÍ≤©Î†• +35)', price: 30000, effectValue: 35, uid: Date.now().toString(), isEquipped: false },
                        { id: 'knight_killer', name: 'ÎÇòÏù¥Ìä∏ ÌÇ¨Îü¨', type: 'WEAPON', slot: 'WEAPON', description: 'Í∞ëÏò∑ÏùÑ Îö´Îäî Îã®Í≤Ä. (Í≥µÍ≤©Î†• +35)', price: 30000, effectValue: 35, uid: (Date.now()+1).toString(), isEquipped: false }
                    ];
                    // Free Gacha Ticket x20
                    const tickets = { id: 'gacha_ticket', name: 'Î¨¥Î£å ÎΩëÍ∏∞Í∂å', type: 'CONSUMABLE', description: 'ÎûúÎç§ Î∞ïÏä§Î•º 1Ìöå Î¨¥Î£åÎ°ú ÏóΩÎãàÎã§.', price: 1000, effectValue: 0, count: 20 };
                    
                    setPlayer(prev => {
                        const newInventory = [...prev.inventory];
                        // Add Elixirs
                        const existingElixir = newInventory.find(i => i.id === 'elixir');
                        if (existingElixir) existingElixir.count = (existingElixir.count || 0) + 20;
                        else newInventory.push(elixirs);
                        
                        // Add Tickets
                        const existingTicket = newInventory.find(i => i.id === 'gacha_ticket');
                        if (existingTicket) existingTicket.count = (existingTicket.count || 0) + 20;
                        else newInventory.push(tickets);
                        
                        // Add Weapons
                        killers.forEach(k => newInventory.push(k));
                        
                        return { ...prev, gold: prev.gold + 2500, inventory: newInventory };
                    });
                    addLog("Í¥ÄÎ¶¨Ïûê ÏΩîÎìú 'hello' Ï†ÅÏö©: ÏóòÎ¶≠ÏÑú 20Í∞ú, ÎÇòÏù¥Ìä∏ÌÇ¨Îü¨ 2Í∞ú, ÎΩëÍ∏∞Í∂å 20Í∞ú, 2500G ÏßÄÍ∏â!", 'gain');

                } else if (code === '1014') {
                    setPlayer(prev => ({ ...prev, gold: prev.gold + 50000 }));
                    addLog("Í¥ÄÎ¶¨Ïûê ÏΩîÎìú: 50,000G ÏßÄÍ∏â.", 'gain');
                } else if (code === '3237') {
                     const kamish = { id: 'kamish', name: 'Í∑∏Î¶ºÏûê Ïπ¥ÎØ∏Ïâ¨', rank: Rank.S, description: 'ÌååÎ©∏Ïùò Ïö©', type: 'SHADOW', role: 'ÎìúÎûòÍ≥§', attackBonus: 500 };
                     if (!player.companions.find(c => c.id === 'kamish')) {
                        setPlayer(prev => ({ ...prev, companions: [...prev.companions, kamish] }));
                        addLog("Í¥ÄÎ¶¨Ïûê ÏΩîÎìú: Í∑∏Î¶ºÏûê 'Ïπ¥ÎØ∏Ïâ¨' ÏÜåÌôò.", 'gain');
                     }
                } else if (code === '6717') {
                    const iaido = { id: 'iaido', name: 'Î∞úÎèÑÏà†', description: 'Î≥¥Ïù¥ÏßÄ ÏïäÎäî ÏÜçÎèÑÎ°ú Î≤†Ïñ¥ÎÉÖÎãàÎã§.', mpCost: 40, cooldown: 2, damageMult: 3.5, level: 1 };
                    if (!player.skills.find(s => s.id === 'iaido')) {
                        setPlayer(prev => ({ ...prev, skills: [...prev.skills, iaido] }));
                        addLog("Í¥ÄÎ¶¨Ïûê ÏΩîÎìú: Ïä§ÌÇ¨ 'Î∞úÎèÑÏà†' ÏäµÎìù.", 'gain');
                    }
                } else {
                    addLog("Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÏΩîÎìú.", 'info');
                }
            };

            const handleUpgradeSkill = (type) => {
                if (!selectedSkillForUpgrade) return;
                const skillIndex = player.skills.findIndex(s => s.id === selectedSkillForUpgrade.id);
                if (skillIndex === -1) return;
                const currentSkill = player.skills[skillIndex];
                const cost = Math.floor(500 * currentSkill.level);
                if (player.gold < cost) { addLog(`Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§. (ÌïÑÏöî: ${cost}G)`, 'danger'); return; }

                let updatedSkill = { ...currentSkill, level: currentSkill.level + 1 };
                let upgradedText = "";
                if (type === 'damage' && updatedSkill.damageMult) {
                    updatedSkill.damageMult = parseFloat((updatedSkill.damageMult + 0.2).toFixed(1)); upgradedText = "Í≥µÍ≤©Î†• Ï¶ùÍ∞Ä";
                } else if (type === 'cost') {
                    updatedSkill.mpCost = Math.max(1, updatedSkill.mpCost - 2); upgradedText = "MP ÏÜåÎ™® Í∞êÏÜå";
                } else if (type === 'cooldown') {
                    updatedSkill.cooldown = Math.max(0, updatedSkill.cooldown - 1); upgradedText = "Ïû¨ÏÇ¨Ïö© ÎåÄÍ∏∞ÏãúÍ∞Ñ Í∞êÏÜå";
                }
                const newSkills = [...player.skills];
                newSkills[skillIndex] = updatedSkill;
                setPlayer(prev => ({ ...prev, gold: prev.gold - cost, skills: newSkills }));
                addLog(`„ÄêÏä§ÌÇ¨ Í∞ïÌôî„Äë ${updatedSkill.name} Lv.${updatedSkill.level} (${upgradedText})`, 'gain');
                setSelectedSkillForUpgrade(null);
            };

            if (!gameStarted) {
                return (
                    <div className="min-h-screen w-full bg-black text-system-text flex flex-col items-center justify-center p-4 relative overflow-hidden font-sans">
                        <div className="absolute inset-0 bg-[linear-gradient(rgba(0,168,255,0.05)_1px,transparent_1px),linear-gradient(90deg,rgba(0,168,255,0.05)_1px,transparent_1px)] bg-[size:40px_40px]"></div>
                        <div className="z-10 bg-system-panel/90 border border-system-blue p-8 rounded-lg shadow-[0_0_30px_rgba(0,168,255,0.3)] max-w-md w-full text-center">
                            <h1 className="text-4xl font-bold text-system-blue tracking-[0.2em] mb-8">SYSTEM</h1>
                            
                            {player.name && (
                                <div className="mb-6 p-4 bg-gray-900 border border-gray-700 rounded">
                                    <p className="text-gray-400 text-sm mb-2">Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞ Î∞úÍ≤¨</p>
                                    <p className="text-xl font-bold text-white">{player.name} <span className="text-sm text-yellow-500">Lv.{player.level}</span></p>
                                    <button onClick={handleContinueGame} className="w-full mt-4 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded">Ïù¥Ïñ¥ÌïòÍ∏∞</button>
                                </div>
                            )}

                            <div className="border-t border-gray-700 pt-6">
                                <p className="text-gray-500 text-xs mb-2">ÏÉàÎ°ú ÏãúÏûëÌïòÍ∏∞</p>
                                <input type="text" value={playerNameInput} onChange={(e) => setPlayerNameInput(e.target.value)} placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" className="w-full bg-black/50 border border-gray-700 focus:border-system-blue rounded p-4 text-white outline-none mb-4 text-lg" autoFocus onKeyDown={(e) => e.key === 'Enter' && handleStartGame()} />
                                <button onClick={handleStartGame} disabled={!playerNameInput.trim()} className="w-full bg-system-blue hover:bg-blue-600 text-black font-bold py-4 rounded disabled:opacity-30">Îì±Î°ù ÏôÑÎ£å</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen w-full bg-system-dark text-system-text flex flex-col p-2 lg:p-6 relative">
                    <div className="fixed inset-0 pointer-events-none z-0 opacity-20 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-blue-900/20 via-black to-black"></div>
                    
                    <header className="relative z-10 flex justify-between items-center mb-6 border-b border-system-blue/30 pb-4 shrink-0">
                        <h1 className="text-xl lg:text-3xl font-bold tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-system-blue to-white drop-shadow-[0_0_10px_rgba(0,168,255,0.8)]">
                            SOLO LEVELING <span className="text-xs align-top text-system-blue">SYSTEM</span>
                        </h1>
                        <div className="flex items-center gap-4">
                            <div className="flex gap-2 text-xs">
                                <button onClick={handleManualSave} className="px-3 py-1 bg-gray-800 border border-gray-600 rounded hover:bg-system-blue hover:text-black hover:border-system-blue transition-colors">üíæ Ï†ÄÏû•</button>
                                <button onClick={handleResetGame} className="px-3 py-1 bg-gray-800 border border-gray-600 rounded hover:bg-red-600 hover:text-white hover:border-red-600 transition-colors">üîÑ Ï¥àÍ∏∞Ìôî</button>
                            </div>
                            <div className="text-yellow-500 font-bold font-mono">GOLD: {player.gold.toLocaleString()}</div>
                        </div>
                    </header>

                    <main className="relative z-10 flex flex-col lg:flex-row gap-6 flex-1 max-w-7xl mx-auto w-full">
                        <StatusWindow 
                            player={player} 
                            onIncreaseStat={(stat) => { if (player.statPoints > 0) setPlayer(prev => ({ ...prev, stats: { ...prev.stats, [stat]: prev.stats[stat] + 1 }, statPoints: prev.statPoints - 1 })); }} 
                            onToggleEquip={handleToggleEquip}
                            onOpenCodeModal={() => { setIsCodeModalOpen(true); setCodeInput(""); }}
                        />
                        <div className="flex-1 flex flex-col gap-6 min-w-0">
                            <GameLog logs={logs} />
                            <ActionPanel 
                                player={player} 
                                addLog={addLog} 
                                updatePlayer={(updates) => setPlayer(prev => ({ ...prev, ...updates }))}
                                onEnemyDefeated={handleEnemyDefeated}
                                onPlayerDamage={(dmg) => {
                                    const newHp = player.hp - dmg;
                                    setPlayer(prev => ({ ...prev, hp: newHp }));
                                    if (newHp <= 0) {
                                        addLog("Ìå®Î∞∞ÌñàÏäµÎãàÎã§. Í≤ΩÌóòÏπòÏôÄ Í≥®ÎìúÎ•º ÏùºÎ∂Ä ÏûÉÏäµÎãàÎã§.", 'danger');
                                        setPlayer(prev => ({ ...prev, hp: Math.floor(prev.maxHp * 0.1), currentExp: Math.floor(prev.currentExp * 0.7), gold: Math.floor(prev.gold * 0.8) }));
                                    }
                                }}
                            />
                        </div>
                    </main>

                    {isLevelUp && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                            <div className="bg-system-panel border-2 border-yellow-400 p-8 rounded-lg text-center shadow-[0_0_50px_rgba(250,204,21,0.4)]">
                                <h2 className="text-3xl font-bold text-yellow-400 mb-2 animate-bounce">LEVEL UP!</h2>
                                <button onClick={() => setIsLevelUp(false)} className="mt-4 px-6 py-2 bg-yellow-500 text-black font-bold rounded">ÌôïÏù∏</button>
                            </div>
                        </div>
                    )}
                    
                    {isCodeModalOpen && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
                             <div className="bg-system-panel border border-system-blue p-6 rounded-lg w-full max-w-sm">
                                 <h2 className="text-system-blue font-bold mb-4">ADMINISTRATOR CODE</h2>
                                 <input type="password" value={codeInput} onChange={(e) => setCodeInput(e.target.value)} className="w-full bg-black border border-gray-700 text-center text-lg text-white p-2 mb-4" autoFocus />
                                 <div className="flex gap-2">
                                     <button onClick={handleSubmitCode} className="flex-1 bg-system-blue text-black font-bold py-2 rounded">SUBMIT</button>
                                     <button onClick={() => setIsCodeModalOpen(false)} className="flex-1 bg-gray-800 text-gray-300 py-2 rounded">CANCEL</button>
                                 </div>
                             </div>
                        </div>
                    )}
                    
                    {selectedSkillForUpgrade && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                            <div className="bg-system-panel border border-system-blue p-6 rounded-lg max-w-md w-full relative">
                                <button onClick={() => setSelectedSkillForUpgrade(null)} className="absolute top-2 right-4 text-gray-500">‚úï</button>
                                <h2 className="text-xl font-bold text-system-blue mb-1">SKILL EVOLUTION</h2>
                                <div className="space-y-3 mt-4">
                                    <div className="text-center mb-4">
                                        <span className="text-gray-400 text-xs">ÌïÑÏöî Í≥®Îìú</span>
                                        <div className="text-yellow-400 font-bold font-mono text-xl">{Math.floor(500 * selectedSkillForUpgrade.level)} G</div>
                                    </div>
                                    {selectedSkillForUpgrade.damageMult && <button onClick={() => handleUpgradeSkill('damage')} className="w-full p-3 bg-gray-800 border border-gray-600 rounded flex justify-between"><span>ÌååÍ¥¥Î†• Í∞ïÌôî</span><span>‚öîÔ∏è</span></button>}
                                    <button onClick={() => handleUpgradeSkill('cost')} disabled={selectedSkillForUpgrade.mpCost <= 1} className="w-full p-3 bg-gray-800 border border-gray-600 rounded flex justify-between"><span>Ìö®Ïú®ÏÑ± Ï¶ùÎåÄ</span><span>üíß</span></button>
                                    <button onClick={() => handleUpgradeSkill('cooldown')} disabled={selectedSkillForUpgrade.cooldown <= 0} className="w-full p-3 bg-gray-800 border border-gray-600 rounded flex justify-between"><span>ÏÜçÎèÑ Í∞ïÌôî</span><span>‚ö°</span></button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>